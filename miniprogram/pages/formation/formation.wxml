<!--pages/formation/formation.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨æ  -->
  <view class="top-bar">
    <view class="back-btn" bindtap="goBack">â—€ è¿”å›</view>
    <view class="page-title">âš”ï¸ é˜µå‹é…ç½®</view>
    <view class="save-btn" bindtap="saveFormation">ä¿å­˜</view>
  </view>
  
  <!-- ä¸»å†…å®¹ -->
  <view class="main-content">
    <!-- å·¦ä¾§ï¼šé˜µå‹å±•ç¤º -->
    <view class="formation-panel">
      <view class="panel-title">æˆ˜æ–—é˜µå‹</view>
      
      <!-- é˜µå‹å¸ƒå±€ - ç«–ç€ä¸‰æ’ï¼Œå³ä¾§ä¼˜å…ˆçº§æœ€é«˜ -->
      <!-- å¸ƒå±€ï¼šå‰æ’(1,2) - ä¸­æ’(3,4) - åæ’(5,6)ï¼Œåæ’ä¼˜å…ˆçº§æœ€é«˜ -->
      <view class="formation-grid">
        <!-- å‰æ’ï¼ˆä¼˜å…ˆçº§æœ€ä½ï¼‰ -->
        <view class="formation-column">
          <view class="column-label">å‰æ’</view>
          <view class="formation-slot {{slots[0].empty ? 'empty' : slots[0].qualityClass}}" 
                bindtap="onSlotTap" data-index="0">
            <view class="slot-index">1</view>
            <view class="unit-card">
              <view class="unit-flag my-flag">ğŸš©</view>
              <block wx:if="{{!slots[0].empty}}">
                <view class="unit-avatar">{{slots[0].quality.icon || 'ğŸ‘¤'}}</view>
                <text class="unit-name">{{slots[0].generalName}}</text>
              </block>
              <block wx:else>
                <view class="unit-avatar empty-avatar">+</view>
                <text class="empty-text">ç©º</text>
              </block>
            </view>
          </view>
          <view class="formation-slot {{slots[1].empty ? 'empty' : slots[1].qualityClass}}" 
                bindtap="onSlotTap" data-index="1">
            <view class="slot-index">2</view>
            <view class="unit-card">
              <view class="unit-flag my-flag">ğŸš©</view>
              <block wx:if="{{!slots[1].empty}}">
                <view class="unit-avatar">{{slots[1].quality.icon || 'ğŸ‘¤'}}</view>
                <text class="unit-name">{{slots[1].generalName}}</text>
              </block>
              <block wx:else>
                <view class="unit-avatar empty-avatar">+</view>
                <text class="empty-text">ç©º</text>
              </block>
            </view>
          </view>
        </view>
        
        <!-- ä¸­æ’ï¼ˆä¸­ç­‰ä¼˜å…ˆçº§ï¼‰ -->
        <view class="formation-column">
          <view class="column-label">ä¸­æ’</view>
          <view class="formation-slot {{slots[2].empty ? 'empty' : slots[2].qualityClass}}" 
                bindtap="onSlotTap" data-index="2">
            <view class="slot-index">3</view>
            <view class="unit-card">
              <view class="unit-flag my-flag">ğŸš©</view>
              <block wx:if="{{!slots[2].empty}}">
                <view class="unit-avatar">{{slots[2].quality.icon || 'ğŸ‘¤'}}</view>
                <text class="unit-name">{{slots[2].generalName}}</text>
              </block>
              <block wx:else>
                <view class="unit-avatar empty-avatar">+</view>
                <text class="empty-text">ç©º</text>
              </block>
            </view>
          </view>
          <view class="formation-slot {{slots[3].empty ? 'empty' : slots[3].qualityClass}}" 
                bindtap="onSlotTap" data-index="3">
            <view class="slot-index">4</view>
            <view class="unit-card">
              <view class="unit-flag my-flag">ğŸš©</view>
              <block wx:if="{{!slots[3].empty}}">
                <view class="unit-avatar">{{slots[3].quality.icon || 'ğŸ‘¤'}}</view>
                <text class="unit-name">{{slots[3].generalName}}</text>
              </block>
              <block wx:else>
                <view class="unit-avatar empty-avatar">+</view>
                <text class="empty-text">ç©º</text>
              </block>
            </view>
          </view>
        </view>
        
        <!-- åæ’ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰ -->
        <view class="formation-column center-column">
          <view class="column-label center-label">â­ åæ’</view>
          <view class="formation-slot {{slots[4].empty ? 'empty' : slots[4].qualityClass}}" 
                bindtap="onSlotTap" data-index="4">
            <view class="slot-index">5</view>
            <view class="unit-card">
              <view class="unit-flag my-flag">ğŸš©</view>
              <block wx:if="{{!slots[4].empty}}">
                <view class="unit-avatar">{{slots[4].quality.icon || 'ğŸ‘¤'}}</view>
                <text class="unit-name">{{slots[4].generalName}}</text>
              </block>
              <block wx:else>
                <view class="unit-avatar empty-avatar">+</view>
                <text class="empty-text">ç©º</text>
              </block>
            </view>
          </view>
          <view class="formation-slot {{slots[5].empty ? 'empty' : slots[5].qualityClass}}" 
                bindtap="onSlotTap" data-index="5">
            <view class="slot-index">6</view>
            <view class="unit-card">
              <view class="unit-flag my-flag">ğŸš©</view>
              <block wx:if="{{!slots[5].empty}}">
                <view class="unit-avatar">{{slots[5].quality.icon || 'ğŸ‘¤'}}</view>
                <text class="unit-name">{{slots[5].generalName}}</text>
              </block>
              <block wx:else>
                <view class="unit-avatar empty-avatar">+</view>
                <text class="empty-text">ç©º</text>
              </block>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æˆ˜æ–—é¡ºåºè¯´æ˜ -->
      <view class="order-hint">
        <text class="hint-title">âš¡ å‡ºæˆ˜é¡ºåº</text>
        <text class="hint-text">æœºåŠ¨æ€§é«˜ä¼˜å…ˆï¼Œç›¸åŒæ—¶å³ä¾§(åæ’)ä¼˜å…ˆ</text>
      </view>
      
      <!-- å½“å‰å‡ºæˆ˜é¡ºåºé¢„è§ˆ -->
      <view class="battle-order" wx:if="{{battleOrder.length > 0}}">
        <text class="order-label">è¡ŒåŠ¨é¡ºåºï¼š</text>
        <view class="order-list">
          <view class="order-item" wx:for="{{battleOrder}}" wx:key="index">
            <text class="order-num">{{index + 1}}</text>
            <text class="order-name">{{item.name}}</text>
            <text class="order-mob">({{item.mobility}})</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- å³ä¾§ï¼šæ­¦å°†åˆ—è¡¨ -->
    <view class="general-panel">
      <view class="panel-header">
        <text class="panel-title">æˆ‘çš„æ­¦å°†</text>
        <text class="panel-count">{{generals.length}}äºº</text>
      </view>
      
      <!-- ç­›é€‰ -->
      <view class="filter-bar">
        <view class="filter-item {{filterQuality === 'all' ? 'active' : ''}}" 
              bindtap="setFilter" data-filter="all">å…¨éƒ¨</view>
        <view class="filter-item {{filterQuality === 'orange' ? 'active' : ''}}" 
              bindtap="setFilter" data-filter="orange">ğŸŸ æ©™</view>
        <view class="filter-item {{filterQuality === 'purple' ? 'active' : ''}}" 
              bindtap="setFilter" data-filter="purple">ğŸŸ£ç´«</view>
        <view class="filter-item {{filterQuality === 'red' ? 'active' : ''}}" 
              bindtap="setFilter" data-filter="red">ğŸ”´çº¢</view>
        <view class="filter-item {{filterQuality === 'blue' ? 'active' : ''}}" 
              bindtap="setFilter" data-filter="blue">ğŸ”µè“</view>
      </view>
      
      <!-- æ­¦å°†åˆ—è¡¨ -->
      <scroll-view class="general-list" scroll-y>
        <view class="general-item {{item.inFormation ? 'in-formation' : ''}} {{item.qualityClass}}" 
              wx:for="{{filteredGenerals}}" wx:key="id"
              bindtap="onGeneralTap" data-general="{{item}}">
          <view class="general-icon">{{item.quality.icon || 'ğŸ‘¤'}}</view>
          <view class="general-info">
            <text class="general-name">{{item.name}}</text>
            <text class="general-detail">Lv.{{item.level}} Â· {{item.type.name}}</text>
          </view>
          <view class="general-stats">
            <text class="stat-item">æ”»{{item.attributes.attack}}</text>
            <text class="stat-item">æœº{{item.attributes.mobility}}</text>
          </view>
          <view class="in-formation-mark" wx:if="{{item.inFormation}}">
            <text>å·²ä¸Šé˜µ</text>
          </view>
        </view>
        
        <view class="empty-list" wx:if="{{filteredGenerals.length === 0}}">
          <text>æš‚æ— æ­¦å°†</text>
        </view>
      </scroll-view>
    </view>
  </view>
  
  <!-- é€‰æ‹©æ­¦å°†å¼¹çª— -->
  <view class="modal" wx:if="{{showModal}}">
    <view class="modal-mask" bindtap="closeModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>é€‰æ‹©æ­¦å°† - æ§½ä½{{selectedSlot + 1}}</text>
        <view class="modal-close" bindtap="closeModal">âœ•</view>
      </view>
      <view class="modal-body">
        <view class="modal-option clear" bindtap="clearSlot">
          <text>ğŸš« æ¸…ç©ºæ­¤æ§½ä½</text>
        </view>
        <scroll-view class="modal-list" scroll-y>
          <view class="modal-general {{item.inFormation ? 'disabled' : ''}} {{item.qualityClass}}" 
                wx:for="{{availableGenerals}}" wx:key="id"
                bindtap="selectGeneral" data-general="{{item}}">
            <view class="mg-icon">{{item.quality.icon || 'ğŸ‘¤'}}</view>
            <view class="mg-info">
              <text class="mg-name">{{item.name}}</text>
              <text class="mg-stat">æœºåŠ¨{{item.attributes.mobility}} Â· æ”»å‡»{{item.attributes.attack}}</text>
            </view>
            <view class="mg-status" wx:if="{{item.inFormation}}">å·²ä¸Šé˜µ</view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</view>

