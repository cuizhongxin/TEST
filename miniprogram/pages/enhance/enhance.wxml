<!--pages/enhance/enhance.wxml - ç²¾ç‚¼ç³»ç»Ÿ-->
<wxs module="utils">
  // æ£€æŸ¥è£…å¤‡æ˜¯å¦è¢«é€‰ä¸­
  function isSelected(list, itemId) {
    if (!list || !list.length) return false;
    for (var i = 0; i < list.length; i++) {
      if (list[i] && list[i].id === itemId) return true;
    }
    return false;
  }
  module.exports = { isSelected: isSelected };
</wxs>

<view class="page-container">
  <!-- é¡¶éƒ¨é€‰é¡¹å¡ -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 'enhance' ? 'active' : ''}}" bindtap="switchTab" data-tab="enhance">
      <text class="tab-icon">âš”ï¸</text>
      <text class="tab-text">è£…å¤‡å¼ºåŒ–</text>
    </view>
    <view class="tab-item {{activeTab === 'quality' ? 'active' : ''}}" bindtap="switchTab" data-tab="quality">
      <text class="tab-icon">ğŸ’</text>
      <text class="tab-text">è£…å¤‡å“è´¨</text>
    </view>
    <view class="tab-item {{activeTab === 'fuse' ? 'active' : ''}}" bindtap="switchTab" data-tab="fuse">
      <text class="tab-icon">ğŸ”®</text>
      <text class="tab-text">å¥—è£…èåˆ</text>
    </view>
    <view class="tab-item {{activeTab === 'decompose' ? 'active' : ''}}" bindtap="switchTab" data-tab="decompose">
      <text class="tab-icon">ğŸ”¨</text>
      <text class="tab-text">è£…å¤‡åˆ†è§£</text>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <view class="main-content">
    <!-- å·¦ä¾§æ­¦å°†åˆ—è¡¨ -->
    <view class="left-panel" wx:if="{{activeTab === 'enhance' || activeTab === 'quality'}}">
      <view class="panel-title">é€‰æ‹©æ­¦å°†</view>
      <scroll-view scroll-y class="general-scroll">
        <view class="general-item {{selectedGeneral && selectedGeneral.id === item.id ? 'active' : ''}}"
              wx:for="{{generals}}" wx:key="id"
              bindtap="selectGeneral" data-general="{{item}}">
          <view class="general-avatar">
            <image src="{{item.avatar || '/images/avatar-default.png'}}" mode="aspectFill"></image>
          </view>
          <view class="general-info">
            <text class="general-name">{{item.name}}</text>
            <text class="general-type">({{item.troopType || 'æ­¥'}})</text>
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- ä¸­é—´è£…å¤‡åŒº -->
    <view class="center-panel" wx:if="{{activeTab === 'enhance' || activeTab === 'quality'}}">
      <!-- æ­¦å°†ä¿¡æ¯ -->
      <view class="general-detail" wx:if="{{selectedGeneral}}">
        <view class="general-header">
          <image class="general-portrait" src="{{selectedGeneral.avatar || '/images/avatar-default.png'}}" mode="aspectFill"></image>
          <view class="general-stats">
            <view class="general-title">
              <text class="name">{{selectedGeneral.name}}</text>
              <text class="level">LV:{{selectedGeneral.level || 1}}</text>
            </view>
            <view class="stat-row">
              <text>ç»Ÿé¢†éƒ¨é˜Ÿï¼š{{selectedGeneral.troopName || 'æ­¥å…µ'}}</text>
            </view>
            <view class="stat-grid">
              <view class="stat-item">
                <text class="stat-label">æ­¦</text>
                <text class="stat-key">å‹‡:</text>
                <text class="stat-value">{{selectedGeneral.valor || 0}}</text>
              </view>
              <view class="stat-item">
                <text class="stat-label">ç»Ÿ</text>
                <text class="stat-key">å¾¡:</text>
                <text class="stat-value">{{selectedGeneral.command || 0}}</text>
              </view>
              <view class="stat-item">
                <text class="stat-label">æ”»</text>
                <text class="stat-key">å‡»:</text>
                <text class="stat-value">{{selectedGeneral.attack || 0}}</text>
              </view>
              <view class="stat-item">
                <text class="stat-label">é˜²</text>
                <text class="stat-key">å¾¡:</text>
                <text class="stat-value">{{selectedGeneral.defense || 0}}</text>
              </view>
            </view>
          </view>
          <view class="dismiss-btn">è§£é›‡</view>
        </view>

        <!-- å¥—è£…æ•ˆæœ -->
        <view class="set-effect" wx:if="{{setEffect}}">
          <text class="set-name">{{setEffect.name}} {{setEffect.count}}/6</text>
          <text class="set-bonus">{{setEffect.bonus}}</text>
        </view>

        <!-- è£…å¤‡æ§½ä½ -->
        <view class="equipment-grid">
          <view class="equipment-slot {{selectedEquipment && equipments[item.id] && selectedEquipment.id === equipments[item.id].id ? 'active' : ''}}"
                wx:for="{{slotTypes}}" wx:key="id"
                bindtap="selectSlot" data-slot-id="{{item.id}}">
            <view class="slot-icon">
              <image wx:if="{{equipments[item.id]}}" 
                     src="{{equipments[item.id].icon || '/images/equip-default.png'}}" 
                     mode="aspectFill"
                     class="quality-{{equipments[item.id].quality.id || 1}}"></image>
              <text wx:else class="empty-icon">{{item.icon}}</text>
            </view>
            <view class="slot-enhance" wx:if="{{equipments[item.id]}}">
              +{{equipments[item.id].enhanceLevel || 0}}
            </view>
            <view class="slot-name">{{equipments[item.id] ? equipments[item.id].name : item.name}}</view>
          </view>
        </view>
      </view>

      <view class="empty-tip" wx:else>
        <text>è¯·é€‰æ‹©ä¸€ä¸ªæ­¦å°†</text>
      </view>
    </view>

    <!-- å³ä¾§æ“ä½œåŒº -->
    <view class="right-panel">
      <!-- è£…å¤‡å¼ºåŒ– -->
      <view class="operation-panel" wx:if="{{activeTab === 'enhance'}}">
        <view class="panel-title">è£…å¤‡å¼ºåŒ–</view>
        
        <view class="enhance-content" wx:if="{{selectedEquipment && enhanceInfo}}">
          <view class="equip-preview">
            <view class="equip-icon quality-{{selectedEquipment.quality.id || 1}}">
              <image src="{{selectedEquipment.icon || '/images/equip-default.png'}}" mode="aspectFill"></image>
              <text class="enhance-badge">+{{enhanceInfo.currentLevel}}</text>
            </view>
            <view class="equip-detail">
              <text class="equip-name">{{selectedEquipment.name}}</text>
              <text class="enhance-level">å¼ºåŒ–ç­‰çº§: +{{enhanceInfo.currentLevel}} / +{{enhanceInfo.maxLevel}}</text>
            </view>
          </view>

          <!-- å¼ºåŒ–å±æ€§é¢„è§ˆ -->
          <view class="enhance-preview">
            <view class="preview-title">å¼ºåŒ–åŠ æˆ:</view>
            <view class="attr-compare">
              <view class="current-attr">
                <text class="attr-label">å½“å‰</text>
                <text wx:if="{{enhanceInfo.currentBonus.attack}}">æ”»å‡»+{{enhanceInfo.currentBonus.attack}}</text>
                <text wx:if="{{enhanceInfo.currentBonus.defense}}">é˜²å¾¡+{{enhanceInfo.currentBonus.defense}}</text>
                <text wx:if="{{enhanceInfo.currentBonus.hp}}">ç”Ÿå‘½+{{enhanceInfo.currentBonus.hp}}</text>
              </view>
              <view class="arrow" wx:if="{{enhanceInfo.canEnhance}}">â†’</view>
              <view class="next-attr" wx:if="{{enhanceInfo.canEnhance}}">
                <text class="attr-label">ä¸‹ä¸€çº§</text>
                <text class="highlight" wx:if="{{enhanceInfo.nextBonus.attack}}">æ”»å‡»+{{enhanceInfo.nextBonus.attack}}</text>
                <text class="highlight" wx:if="{{enhanceInfo.nextBonus.defense}}">é˜²å¾¡+{{enhanceInfo.nextBonus.defense}}</text>
                <text class="highlight" wx:if="{{enhanceInfo.nextBonus.hp}}">ç”Ÿå‘½+{{enhanceInfo.nextBonus.hp}}</text>
              </view>
            </view>
          </view>

          <!-- å¼ºåŒ–æ¶ˆè€— -->
          <view class="cost-info" wx:if="{{enhanceInfo.canEnhance}}">
            <view class="cost-row">
              <text class="cost-label">æˆåŠŸç‡:</text>
              <text class="cost-value rate">{{enhanceInfo.successRate}}%</text>
            </view>
            <view class="cost-row">
              <text class="cost-label">æ¶ˆè€—é“¶å¸:</text>
              <text class="cost-value">{{enhanceInfo.silverCost}}</text>
            </view>
            <view class="cost-row">
              <text class="cost-label">æ¶ˆè€—å¼ºåŒ–çŸ³:</text>
              <text class="cost-value">{{enhanceInfo.stoneLevel}}çº§ x{{enhanceInfo.stoneCost}}</text>
            </view>
          </view>

          <!-- ä¿æŠ¤ç¬¦é€‰é¡¹ -->
          <view class="protect-option" wx:if="{{enhanceInfo.canEnhance && enhanceInfo.currentLevel >= 5}}">
            <switch checked="{{useProtect}}" bindchange="toggleProtect" color="#ffd700"/>
            <text>ä½¿ç”¨ä¿æŠ¤ç¬¦ï¼ˆå¤±è´¥ä¸æ‰çº§ï¼‰</text>
          </view>

          <!-- å¼ºåŒ–æŒ‰é’® -->
          <view class="action-btn {{enhancing || !enhanceInfo.canEnhance ? 'disabled' : ''}}" 
                bindtap="doEnhance">
            {{enhancing ? 'å¼ºåŒ–ä¸­...' : (enhanceInfo.canEnhance ? 'å¼€å§‹å¼ºåŒ–' : enhanceInfo.message)}}
          </view>
        </view>

        <view class="empty-tip" wx:else>
          <text>è¯·é€‰æ‹©è¦å¼ºåŒ–çš„è£…å¤‡</text>
        </view>
      </view>

      <!-- è£…å¤‡å“è´¨ -->
      <view class="operation-panel" wx:if="{{activeTab === 'quality'}}">
        <view class="panel-title">å“è´¨æå‡</view>
        
        <view class="quality-content" wx:if="{{selectedEquipment && qualityInfo}}">
          <view class="equip-preview">
            <view class="equip-icon quality-{{selectedEquipment.quality.id || 1}}">
              <image src="{{selectedEquipment.icon || '/images/equip-default.png'}}" mode="aspectFill"></image>
            </view>
            <view class="equip-detail">
              <text class="equip-name">{{selectedEquipment.name}}</text>
              <text class="quality-desc">å“è´¨: {{qualityInfo.qualityDesc}}</text>
            </view>
          </view>

          <!-- å“è´¨è¿›åº¦æ¡ -->
          <view class="quality-progress">
            <view class="progress-label">
              <text>å“è´¨å€¼</text>
              <text class="progress-value">{{qualityInfo.currentQuality}}%</text>
            </view>
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{qualityInfo.currentQuality}}%"></view>
            </view>
            <view class="quality-marks">
              <text>ç²—ç³™</text>
              <text>æ™®é€š</text>
              <text>è‰¯å¥½</text>
              <text>ä¼˜ç§€</text>
              <text>ç²¾è‰¯</text>
              <text>å®Œç¾</text>
            </view>
          </view>

          <!-- å“è´¨å±æ€§ -->
          <view class="quality-bonus">
            <view class="preview-title">å“è´¨åŠ æˆ:</view>
            <view class="attr-list">
              <text wx:if="{{qualityInfo.currentBonus.attack}}">æ”»å‡»+{{qualityInfo.currentBonus.attack}}</text>
              <text wx:if="{{qualityInfo.currentBonus.defense}}">é˜²å¾¡+{{qualityInfo.currentBonus.defense}}</text>
              <text wx:if="{{qualityInfo.currentBonus.hp}}">ç”Ÿå‘½+{{qualityInfo.currentBonus.hp}}</text>
            </view>
          </view>

          <!-- æ¶ˆè€— -->
          <view class="cost-info" wx:if="{{qualityInfo.canUpgrade}}">
            <view class="cost-row">
              <text class="cost-label">æå‡èŒƒå›´:</text>
              <text class="cost-value">{{qualityInfo.upgradeRange}}</text>
            </view>
            <view class="cost-row">
              <text class="cost-label">æ¶ˆè€—å“è´¨çŸ³:</text>
              <text class="cost-value">{{qualityInfo.qualityStoneCost}}</text>
            </view>
            <view class="cost-row">
              <text class="cost-label">æ¶ˆè€—é“¶å¸:</text>
              <text class="cost-value">{{qualityInfo.silverCost}}</text>
            </view>
          </view>

          <view class="action-btn {{upgrading || !qualityInfo.canUpgrade ? 'disabled' : ''}}" 
                bindtap="doUpgradeQuality">
            {{upgrading ? 'æå‡ä¸­...' : (qualityInfo.canUpgrade ? 'æå‡å“è´¨' : qualityInfo.message)}}
          </view>
        </view>

        <view class="empty-tip" wx:else>
          <text>è¯·é€‰æ‹©è¦æå‡å“è´¨çš„è£…å¤‡</text>
        </view>
      </view>

      <!-- å¥—è£…èåˆ -->
      <view class="operation-panel fuse-panel" wx:if="{{activeTab === 'fuse'}}">
        <view class="panel-title">å¥—è£…èåˆ</view>
        <view class="fuse-tip">é€‰æ‹©3ä»¶åŒå¥—è£…è£…å¤‡ï¼Œå¯èåˆæˆæŒ‡å®šéƒ¨ä½</view>

        <!-- å·²é€‰è£…å¤‡ -->
        <view class="selected-equipments">
          <view class="selected-slot" wx:for="{{[0,1,2]}}" wx:key="*this">
            <view class="slot-content" wx:if="{{fuseEquipments[item]}}">
              <image src="{{fuseEquipments[item].icon || '/images/equip-default.png'}}" mode="aspectFill"></image>
              <text class="slot-label">{{fuseEquipments[item].name}}</text>
            </view>
            <view class="slot-empty" wx:else>
              <text>+</text>
            </view>
          </view>
        </view>

        <!-- å¯é€‰è£…å¤‡åˆ—è¡¨ -->
        <view class="fuse-list-title">å¯èåˆè£…å¤‡</view>
        <scroll-view scroll-y class="fuse-equipment-list">
          <view class="fuse-equip-item {{utils.isSelected(fuseEquipments, item.id) ? 'selected' : ''}}"
                wx:for="{{setEquipments}}" wx:key="id"
                bindtap="selectFuseEquipment" data-equipment="{{item}}">
            <image src="{{item.icon || '/images/equip-default.png'}}" mode="aspectFill"></image>
            <view class="fuse-equip-info">
              <text class="fuse-equip-name">{{item.name}}</text>
              <text class="fuse-equip-set">{{item.setInfo.setName}}å¥—è£…</text>
            </view>
            <view class="check-mark" wx:if="{{utils.isSelected(fuseEquipments, item.id)}}">âœ“</view>
          </view>
          <view class="empty-tip" wx:if="{{setEquipments.length === 0}}">
            <text>æ²¡æœ‰å¯èåˆçš„è£…å¤‡</text>
          </view>
        </scroll-view>

        <!-- ç›®æ ‡æ§½ä½é€‰æ‹© -->
        <view class="target-slot-section" wx:if="{{fuseEquipments.length === 3}}">
          <view class="section-title">é€‰æ‹©ç›®æ ‡éƒ¨ä½</view>
          <view class="target-slots">
            <view class="target-slot {{targetSlotId === item.id ? 'active' : ''}}"
                  wx:for="{{slotTypes}}" wx:key="id"
                  bindtap="selectTargetSlot" data-slot-id="{{item.id}}">
              <text class="slot-icon">{{item.icon}}</text>
              <text class="slot-name">{{item.name}}</text>
            </view>
          </view>
        </view>

        <view class="action-btn {{fusing || fuseEquipments.length !== 3 || !targetSlotId ? 'disabled' : ''}}" 
              bindtap="doFuse">
          {{fusing ? 'èåˆä¸­...' : 'å¼€å§‹èåˆ'}}
        </view>
      </view>

      <!-- è£…å¤‡åˆ†è§£ -->
      <view class="operation-panel decompose-panel" wx:if="{{activeTab === 'decompose'}}">
        <view class="panel-title">è£…å¤‡åˆ†è§£</view>
        <view class="decompose-tip">åˆ†è§£å¤šä½™è£…å¤‡ï¼Œè·å¾—å“è´¨çŸ³å’Œé“¶å¸</view>

        <scroll-view scroll-y class="decompose-equipment-list">
          <view class="decompose-equip-item {{utils.isSelected(decomposeEquipments, item.id) ? 'selected' : ''}}"
                wx:for="{{setEquipments}}" wx:key="id"
                bindtap="selectDecomposeEquipment" data-equipment="{{item}}">
            <image src="{{item.icon || '/images/equip-default.png'}}" mode="aspectFill"
                   class="quality-{{item.quality.id || 1}}"></image>
            <view class="decompose-equip-info">
              <text class="decompose-equip-name">{{item.name}}</text>
              <text class="decompose-equip-level">Lv.{{item.level || 20}}</text>
            </view>
            <view class="check-box {{utils.isSelected(decomposeEquipments, item.id) ? 'checked' : ''}}">
              <text wx:if="{{utils.isSelected(decomposeEquipments, item.id)}}">âœ“</text>
            </view>
          </view>
          <view class="empty-tip" wx:if="{{setEquipments.length === 0}}">
            <text>æ²¡æœ‰å¯åˆ†è§£çš„è£…å¤‡</text>
          </view>
        </scroll-view>

        <view class="decompose-summary" wx:if="{{decomposeEquipments.length > 0}}">
          <text>å·²é€‰æ‹© {{decomposeEquipments.length}} ä»¶è£…å¤‡</text>
        </view>

        <view class="action-btn {{decomposing || decomposeEquipments.length === 0 ? 'disabled' : ''}}" 
              bindtap="doDecompose">
          {{decomposing ? 'åˆ†è§£ä¸­...' : 'å¼€å§‹åˆ†è§£'}}
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨èµ„æºæ  -->
  <view class="resource-bar">
    <view class="resource-item">
      <text class="resource-icon">ğŸª™</text>
      <text class="resource-value">{{silver}}</text>
    </view>
    <view class="resource-item">
      <text class="resource-icon">ğŸ’</text>
      <text class="resource-value">{{qualityStone}}</text>
    </view>
    <view class="resource-item" wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this">
      <text class="resource-icon">ğŸ”·{{item}}</text>
      <text class="resource-value">{{enhanceStones[item] || 0}}</text>
    </view>
    <view class="back-btn" bindtap="goBack">è¿”å›</view>
  </view>
</view>
