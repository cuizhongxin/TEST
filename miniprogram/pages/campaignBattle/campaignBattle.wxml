<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-screen">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- æœªå¼€å§‹çŠ¶æ€ - å‡†å¤‡å‡ºå¾ -->
  <view wx:elif="{{!progress || progress.status === 'IDLE' || progress.status === 'COMPLETED'}}" class="prepare-screen">
    <!-- å·¦ä¾§ï¼šæˆ˜å½¹ä¿¡æ¯ -->
    <view class="prepare-left">
      <view class="campaign-info-card">
        <text class="campaign-name">{{campaign.name || 'æˆ˜å½¹'}}</text>
        <text class="campaign-stage">ç¬¬{{(progress.currentStage || 1)}}å…³</text>
        <view class="campaign-desc">
          <text>æ•Œäººç­‰çº§: {{campaign.enemyLevelMin}}-{{campaign.enemyLevelMax}}</text>
          <text>ç»éªŒå¥–åŠ±: {{campaign.expRewardMin}}-{{campaign.expRewardMax}}</text>
        </view>
      </view>
      
      <!-- æˆ‘æ–¹æ­¦å°† -->
      <view class="team-card">
        <text class="card-title">å‡ºæˆ˜é˜µå®¹</text>
        <view class="team-generals">
          <view wx:for="{{formationGenerals}}" wx:key="id" class="team-general {{index === 0 ? 'main' : ''}}">
            <image class="general-avatar" src="{{item.avatar || '/images/general/default.png'}}" mode="aspectFill"></image>
            <text class="general-name">{{item.name}}</text>
            <text class="general-level">Lv.{{item.level}}</text>
          </view>
          <view wx:if="{{formationGenerals.length === 0}}" class="no-general">
            <text>è¯·å…ˆé…ç½®é˜µå‹</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- å³ä¾§ï¼šæ•Œæ–¹ä¿¡æ¯ -->
    <view class="prepare-right">
      <view class="enemy-card" wx:if="{{currentStage}}">
        <text class="card-title">æ•Œæ–¹å°†é¢†</text>
        <view class="enemy-detail">
          <image class="enemy-avatar" src="{{currentStage.enemyGeneralIcon || '/images/general/default.png'}}" mode="aspectFill"></image>
          <view class="enemy-info">
            <text class="enemy-name">{{currentStage.enemyGeneralName}}</text>
            <text class="enemy-stat">ç­‰çº§: Lv.{{currentStage.enemyLevel}}</text>
            <text class="enemy-stat">å…µåŠ›: {{currentStage.enemyTroops}}</text>
            <text class="enemy-stat">æ”»å‡»: {{currentStage.enemyAttack}}</text>
            <text class="enemy-stat">é˜²å¾¡: {{currentStage.enemyDefense}}</text>
          </view>
        </view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <view class="prepare-actions">
        <view class="btn-start" bindtap="startCampaign">
          <text>å‡ºå¾</text>
        </view>
        <view class="btn-back" bindtap="goBack">
          <text>è¿”å›</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆ˜æ–—è¿›è¡Œä¸­ -->
  <view wx:elif="{{progress && progress.status === 'IN_PROGRESS'}}" class="battle-screen">
    <!-- æˆ˜æ–—é¡¶éƒ¨æ  -->
    <view class="battle-header">
      <view class="player-side">
        <image class="side-avatar" src="{{mainGeneral.avatar || '/images/general/default.png'}}" mode="aspectFill"></image>
        <view class="side-info">
          <text class="side-name">{{mainGeneral.name || 'æˆ‘å†›'}}</text>
          <text class="side-level">Lv.{{mainGeneral.level || 1}}</text>
        </view>
        <view class="hp-bar-container">
          <view class="hp-bar player-hp" style="width: {{progress.maxTroops > 0 ? (progress.currentTroops / progress.maxTroops) * 100 : 100}}%"></view>
          <text class="hp-text">{{progress.currentTroops}}/{{progress.maxTroops}}</text>
        </view>
      </view>
      
      <view class="battle-center">
        <view class="battle-icon">æˆ°</view>
        <text class="round-text">ç¬¬{{currentRound}}å›åˆ</text>
      </view>
      
      <view class="enemy-side">
        <view class="hp-bar-container">
          <view class="hp-bar enemy-hp" style="width: {{currentStage.enemyTroops > 0 ? (enemyCurrentTroops / currentStage.enemyTroops) * 100 : 100}}%"></view>
          <text class="hp-text">{{enemyCurrentTroops}}/{{currentStage.enemyTroops}}</text>
        </view>
        <view class="side-info right">
          <text class="side-name">{{currentStage.enemyGeneralName}}</text>
          <text class="side-level">Lv.{{currentStage.enemyLevel}}</text>
        </view>
        <image class="side-avatar enemy" src="{{currentStage.enemyGeneralIcon || '/images/general/default.png'}}" mode="aspectFill"></image>
      </view>
    </view>

    <!-- æˆ˜åœºä¸»åŒºåŸŸ -->
    <view class="battlefield-main">
      <!-- æ”»å‡»åŠ¨ç”» -->
      <view wx:if="{{showAttackAnimation}}" class="attack-animation {{attackDirection}}">
        <view class="attack-effect"></view>
      </view>
      
      <!-- å·¦æ–¹é˜µåˆ—ï¼ˆç©å®¶ï¼‰ -->
      <view class="army-formation player-army {{isPlayerAttacking ? 'attacking' : ''}}">
        <view class="formation-row" wx:for="{{playerFormation}}" wx:key="index" wx:for-item="row">
          <view class="soldier-unit" wx:for="{{row}}" wx:key="idx" wx:for-item="unit">
            <view class="unit-icon {{unit.type}}">
              <text class="unit-flag player-flag">{{unit.flag}}</text>
            </view>
          </view>
        </view>
        <view class="general-position player-general">
          <image class="formation-general-avatar" src="{{mainGeneral.avatar || '/images/general/default.png'}}" mode="aspectFill"></image>
        </view>
      </view>
      
      <!-- ä¸­å¤®VS -->
      <view class="vs-divider">
        <view class="clash-effect {{showClash ? 'active' : ''}}"></view>
      </view>
      
      <!-- å³æ–¹é˜µåˆ—ï¼ˆæ•Œæ–¹ï¼‰ -->
      <view class="army-formation enemy-army {{isEnemyAttacking ? 'attacking' : ''}}">
        <view class="formation-row" wx:for="{{enemyFormation}}" wx:key="index" wx:for-item="row">
          <view class="soldier-unit" wx:for="{{row}}" wx:key="idx" wx:for-item="unit">
            <view class="unit-icon {{unit.type}} enemy-unit">
              <text class="unit-flag enemy-flag">{{unit.flag}}</text>
            </view>
          </view>
        </view>
        <view class="general-position enemy-general">
          <image class="formation-general-avatar enemy" src="{{currentStage.enemyGeneralIcon || '/images/general/default.png'}}" mode="aspectFill"></image>
        </view>
      </view>
    </view>

    <!-- æˆ˜æ–—æ—¥å¿— -->
    <view class="battle-log-panel">
      <scroll-view class="log-scroll" scroll-y scroll-into-view="log-{{battleLogs.length - 1}}">
        <view wx:for="{{battleLogs}}" wx:key="index" id="log-{{index}}" class="log-item {{item.type}}">
          <text>{{item.text}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="battle-footer">
      <view wx:if="{{!isBattling}}" class="action-buttons">
        <view class="btn-action btn-attack" bindtap="startBattle">
          <text>å¼€å§‹æˆ˜æ–—</text>
        </view>
        <view class="btn-action btn-retreat" bindtap="pauseCampaign">
          <text>æ’¤é€€</text>
        </view>
      </view>
      <view wx:else class="battling-hint">
        <text>âš”ï¸ æˆ˜æ–—è¿›è¡Œä¸­...</text>
      </view>
    </view>
  </view>

  <!-- æˆ˜æ–—ç»“æœå¼¹çª— -->
  <view wx:if="{{showBattleResult && battleResult}}" class="result-modal">
    <view class="result-content {{battleResult.victory ? 'victory' : 'defeat'}}">
      <view class="result-banner">
        <text class="result-title">{{battleResult.victory ? 'ğŸ‰ æˆ˜æ–—èƒœåˆ©' : 'ğŸ’€ æˆ˜æ–—å¤±è´¥'}}</text>
      </view>
      
      <view class="result-body">
        <view class="result-row">
          <text class="label">å…³å¡:</text>
          <text class="value">ç¬¬{{battleResult.stageNum}}å…³</text>
        </view>
        <view wx:if="{{battleResult.victory}}" class="result-row">
          <text class="label">è·å¾—ç»éªŒ:</text>
          <text class="value gold">+{{battleResult.expGained}}</text>
        </view>
        <view wx:if="{{battleResult.victory}}" class="result-row">
          <text class="label">è·å¾—ç™½é“¶:</text>
          <text class="value gold">+{{battleResult.silverGained}}</text>
        </view>
        <view class="result-row">
          <text class="label">æˆ‘æ–¹æŸå¤±:</text>
          <text class="value red">-{{battleResult.troopsLost}}</text>
        </view>
        
        <!-- æ‰è½ç‰©å“ -->
        <view wx:if="{{battleResult.drops && battleResult.drops.length > 0}}" class="drops-section">
          <text class="drops-title">è·å¾—ç‰©å“</text>
          <view class="drops-grid">
            <view wx:for="{{battleResult.drops}}" wx:key="itemId" class="drop-item">
              <image class="drop-icon" src="{{item.icon || '/images/item/default.png'}}" mode="aspectFit"></image>
              <text class="drop-count">x{{item.count}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="result-footer">
        <view class="btn-result" bindtap="closeBattleResult">
          <text>{{battleResult.victory && !battleResult.isLastStage ? 'ä¸‹ä¸€å…³' : 'ç¡®å®š'}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
