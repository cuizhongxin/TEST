<!--pages/campaignBattle/campaignBattle.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
  <view class="top-bar">
    <view class="troops-info">
      <text class="troops-label">å·±å…µåŠ›:</text>
      <text class="troops-value">{{progress.currentTroops}}/{{progress.maxTroops}}</text>
      <button class="btn-replenish" size="mini" bindtap="replenishTroops">è¡¥å……</button>
    </view>
    
    <view class="campaign-title">{{campaign.name}}</view>
    
    <view class="action-bar">
      <view class="revive-info">
        <text>é‡ç”Ÿæ¬¡æ•°: {{progress.reviveCount}}</text>
      </view>
      <button class="btn-action" size="mini" bindtap="endCampaign">ç»“æŸæˆ˜å½¹</button>
      <button class="btn-action" size="mini" bindtap="pauseCampaign">æš‚åœæˆ˜å½¹</button>
    </view>
  </view>

  <!-- å½“å‰å…³å¡ä¿¡æ¯ -->
  <view class="stage-info" wx:if="{{currentStage}}">
    <view class="boss-preview">
      <view class="boss-avatar-frame">
        <view class="boss-avatar">
          <text class="boss-icon">ğŸ‘¤</text>
        </view>
      </view>
      <view class="boss-details">
        <view class="boss-row">
          <text class="boss-label">å°†é¢†:</text>
          <text class="boss-value">{{currentStage.bossName}}</text>
        </view>
        <view class="boss-row">
          <text class="boss-label">çº§åˆ«:</text>
          <text class="boss-value">{{currentStage.bossLevel}}çº§</text>
        </view>
        <view class="boss-row">
          <text class="boss-label">ç»éªŒ:</text>
          <text class="boss-value highlight">{{currentStage.expReward}}</text>
        </view>
        <view class="boss-row">
          <text class="boss-label">æ‰è½:</text>
          <text class="boss-value drop">å°†é¢†è£…å¤‡Â·å¤§å™¨ç¯‡</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å…³å¡åˆ—è¡¨ -->
  <scroll-view class="stage-list" scroll-x>
    <view class="stage-scroll">
      <view class="stage-item {{index + 1 === progress.currentStage ? 'current' : ''}} {{index + 1 <= progress.maxClearedStage ? 'cleared' : ''}}"
            wx:for="{{campaign.stages}}"
            wx:key="index"
            data-index="{{index}}"
            bindtap="selectStage">
        <view class="stage-avatar-frame">
          <view class="stage-avatar">
            <text class="stage-icon">ğŸ‘¤</text>
          </view>
          <!-- è¿›æ”»æŒ‰é’® -->
          <view class="attack-badge" wx:if="{{index + 1 === progress.currentStage}}">
            <text>è¿›æ”»</text>
          </view>
          <!-- å·²é€šå…³æ ‡è®° -->
          <view class="cleared-badge" wx:if="{{index + 1 <= progress.maxClearedStage}}">
            <text>âœ“</text>
          </view>
        </view>
        <view class="stage-num">ç¬¬{{index + 1}}å…³</view>
      </view>
    </view>
  </scroll-view>

  <!-- è¿›æ”»æŒ‰é’®ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
  <view class="bottom-actions">
    <button class="btn-attack" bindtap="attackStage" wx:if="{{progress.inProgress && progress.currentStage <= campaign.stages.length}}">
      è¿›æ”»
    </button>
    <button class="btn-complete" wx:if="{{!progress.inProgress || progress.currentStage > campaign.stages.length}}">
      æˆ˜å½¹å®Œæˆ
    </button>
  </view>
</view>

<!-- è¡¥å……å…µåŠ›å¼¹çª— -->
<view class="modal-mask" wx:if="{{showReplenishModal}}" bindtap="closeReplenishModal">
  <view class="replenish-modal" catchtap="">
    <view class="modal-header">
      <text class="modal-title">è¡¥å……å…µåŠ›</text>
      <view class="modal-close" bindtap="closeReplenishModal">âœ•</view>
    </view>
    <view class="modal-body">
      <view class="replenish-info">
        <text>å½“å‰å…µåŠ›: {{progress.currentTroops}}/{{progress.maxTroops}}</text>
      </view>
      <view class="replenish-cost">
        <text>æ¶ˆè€—ç™½é“¶: {{replenishCost}}</text>
      </view>
      <view class="current-silver">
        <text>å½“å‰ç™½é“¶: {{silver}}</text>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-confirm" bindtap="confirmReplenish">ç¡®è®¤è¡¥å……</button>
      <button class="btn-cancel" bindtap="closeReplenishModal">å–æ¶ˆ</button>
    </view>
  </view>
</view>

<!-- æˆ˜æ–—ç»“æœå¼¹çª— -->
<view class="modal-mask" wx:if="{{showBattleResult}}" bindtap="closeBattleResult">
  <view class="battle-result-modal" catchtap="">
    <view class="modal-header {{battleResult.victory ? 'victory' : 'defeat'}}">
      <text class="modal-title">{{battleResult.victory ? 'æˆ˜æ–—èƒœåˆ©' : 'æˆ˜æ–—å¤±è´¥'}}</text>
    </view>
    <view class="modal-body">
      <view class="battle-log">
        <view class="log-item" wx:for="{{battleResult.battleLog}}" wx:key="index">
          <text>{{item}}</text>
        </view>
      </view>
      
      <view class="battle-rewards" wx:if="{{battleResult.victory}}">
        <view class="reward-item">
          <text>è·å¾—ç»éªŒ: {{battleResult.expGained}}</text>
        </view>
        <view class="reward-item">
          <text>è·å¾—ç™½é“¶: {{battleResult.silverGained}}</text>
        </view>
        <view class="drop-items" wx:if="{{battleResult.itemsDropped && battleResult.itemsDropped.length > 0}}">
          <text class="drop-title">æ‰è½ç‰©å“:</text>
          <view class="drop-item" wx:for="{{battleResult.itemsDropped}}" wx:key="index">
            <text>{{item.itemName}}</text>
          </view>
        </view>
      </view>
      
      <view class="battle-loss" wx:if="{{!battleResult.victory}}">
        <view class="loss-item">
          <text>æŸå¤±å…µåŠ›: {{battleResult.troopsLost}}</text>
        </view>
        <view class="loss-item">
          <text>å‰©ä½™å…µåŠ›: {{battleResult.remainingTroops}}</text>
        </view>
        <view class="revive-option" wx:if="{{progress.reviveCount > 0}}">
          <button class="btn-revive" bindtap="revive">é‡ç”Ÿ (å‰©ä½™{{progress.reviveCount}}æ¬¡)</button>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-continue" bindtap="closeBattleResult">ç»§ç»­</button>
    </view>
  </view>
</view>
