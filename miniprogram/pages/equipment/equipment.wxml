<!--pages/equipment/equipment.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨æ  -->
  <view class="top-bar">
    <view class="back-btn" bindtap="goBack">â—€ è¿”å›</view>
    <view class="page-title">âš”ï¸ è£…å¤‡ç®¡ç†</view>
    <view class="placeholder"></view>
  </view>
  
  <!-- ä¸»å†…å®¹åŒº -->
  <view class="main-content">
    <!-- å·¦ä¾§ï¼šæ­¦å°†åˆ—è¡¨ -->
    <view class="generals-panel">
      <view class="panel-title">æ­¦å°†åˆ—è¡¨</view>
      <scroll-view class="generals-scroll" scroll-y>
        <view class="general-item {{selectedGeneral && selectedGeneral.id === item.id ? 'selected' : ''}} {{item.qualityClass}} {{item.inFormation ? 'in-formation' : ''}}"
              wx:for="{{generals}}" wx:key="id"
              bindtap="selectGeneral" data-general="{{item}}">
          <view class="general-avatar">ğŸ‘¤</view>
          <view class="general-info">
            <text class="general-name">{{item.name}}</text>
            <text class="general-level">Lv.{{item.level || 1}}</text>
          </view>
          <view class="formation-badge" wx:if="{{item.inFormation}}">é˜µ</view>
        </view>
        <view class="empty-tip" wx:if="{{generals.length === 0}}">
          æš‚æ— æ­¦å°†
        </view>
      </scroll-view>
    </view>
    
    <!-- ä¸­é—´ï¼šè£…å¤‡æ§½ä½ -->
    <view class="equipment-panel" wx:if="{{selectedGeneral}}">
      <view class="general-header">
        <view class="general-portrait {{selectedGeneral.qualityClass}}">
          <text class="portrait-icon">ğŸ‘¤</text>
        </view>
        <view class="general-detail">
          <text class="general-title">{{selectedGeneral.name}}</text>
          <text class="general-desc">Lv.{{selectedGeneral.level || 1}} {{selectedGeneral.quality.name || ''}}</text>
        </view>
      </view>
      
      <!-- è£…å¤‡æ§½ä½ç½‘æ ¼ -->
      <view class="slots-grid">
        <view class="equipment-slot {{slot.equipment ? slot.equipment.qualityClass : 'empty'}}"
              wx:for="{{equipmentSlots}}" wx:key="id" wx:for-item="slot"
              bindtap="onSlotTap" data-slot="{{slot}}">
          <view class="slot-bg"></view>
          <view class="slot-content">
            <block wx:if="{{slot.equipment}}">
              <text class="slot-equip-icon">{{slot.equipment.icon || slot.icon}}</text>
              <text class="slot-enhance" wx:if="{{slot.equipment.enhanceLevel}}">+{{slot.equipment.enhanceLevel}}</text>
            </block>
            <block wx:else>
              <text class="slot-icon">{{slot.icon}}</text>
              <text class="slot-hint">{{slot.name}}</text>
            </block>
          </view>
        </view>
      </view>
      
      <!-- å¥—è£…æ•ˆæœ -->
      <view class="set-bonus-panel" wx:if="{{setBonus && setBonus.activeCount}}">
        <view class="set-title">
          <text class="set-name">{{setBonus.setName}}</text>
          <text class="set-count">({{setBonus.activeCount}}/6)</text>
        </view>
        <view class="set-effect" wx:if="{{setBonus.threeSetActive}}">
          <text class="effect-label">3ä»¶å¥—:</text>
          <text class="effect-desc">{{setBonus.threeSetEffect}}</text>
        </view>
        <view class="set-effect" wx:if="{{setBonus.sixSetActive}}">
          <text class="effect-label">6ä»¶å¥—:</text>
          <text class="effect-desc">{{setBonus.sixSetEffect}}</text>
        </view>
      </view>
    </view>
    
    <!-- å³ä¾§ï¼šå±æ€§é¢æ¿ -->
    <view class="attributes-panel" wx:if="{{selectedGeneral}}">
      <view class="panel-title">è£…å¤‡å±æ€§åŠ æˆ</view>
      <view class="attr-list">
        <view class="attr-item" wx:if="{{totalAttributes.attack > 0}}">
          <text class="attr-icon">âš”ï¸</text>
          <text class="attr-label">æ”»å‡»åŠ›</text>
          <text class="attr-value">+{{totalAttributes.attack}}</text>
        </view>
        <view class="attr-item" wx:if="{{totalAttributes.defense > 0}}">
          <text class="attr-icon">ğŸ›¡ï¸</text>
          <text class="attr-label">é˜²å¾¡åŠ›</text>
          <text class="attr-value">+{{totalAttributes.defense}}</text>
        </view>
        <view class="attr-item" wx:if="{{totalAttributes.valor > 0}}">
          <text class="attr-icon">ğŸ’ª</text>
          <text class="attr-label">æ­¦å‹‡</text>
          <text class="attr-value">+{{totalAttributes.valor}}</text>
        </view>
        <view class="attr-item" wx:if="{{totalAttributes.command > 0}}">
          <text class="attr-icon">ğŸ“œ</text>
          <text class="attr-label">ç»Ÿå¾¡</text>
          <text class="attr-value">+{{totalAttributes.command}}</text>
        </view>
        <view class="attr-item" wx:if="{{totalAttributes.mobility > 0}}">
          <text class="attr-icon">ğŸƒ</text>
          <text class="attr-label">æœºåŠ¨</text>
          <text class="attr-value">+{{totalAttributes.mobility}}</text>
        </view>
        <view class="attr-item" wx:if="{{totalAttributes.hp > 0}}">
          <text class="attr-icon">â¤ï¸</text>
          <text class="attr-label">ç”Ÿå‘½</text>
          <text class="attr-value">+{{totalAttributes.hp}}</text>
        </view>
      </view>
      
      <view class="empty-attr" wx:if="{{totalAttributes.attack === 0 && totalAttributes.defense === 0 && totalAttributes.valor === 0 && totalAttributes.command === 0 && totalAttributes.mobility === 0 && totalAttributes.hp === 0}}">
        <text>æš‚æ— è£…å¤‡åŠ æˆ</text>
        <text class="empty-hint">ç‚¹å‡»æ§½ä½è£…å¤‡ç‰©å“</text>
      </view>
    </view>
    
    <!-- æœªé€‰æ‹©æ­¦å°†æç¤º -->
    <view class="no-selection" wx:if="{{!selectedGeneral}}">
      <text class="no-icon">ğŸ‘ˆ</text>
      <text class="no-text">è¯·é€‰æ‹©ä¸€åæ­¦å°†</text>
    </view>
  </view>
  
  <!-- èƒŒåŒ…è£…å¤‡å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showBagModal}}" catchtap="closeBagModal">
    <view class="modal-content bag-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©è£…å¤‡ - {{selectedSlot.name}}</text>
        <view class="close-btn" bindtap="closeBagModal">âœ•</view>
      </view>
      <scroll-view class="bag-list" scroll-y>
        <view class="bag-item {{item.qualityClass}}"
              wx:for="{{bagEquipments}}" wx:key="id"
              wx:if="{{!selectedSlot || (item.slotType && item.slotType.id === selectedSlot.id)}}"
              bindtap="selectBagEquipment" data-equipment="{{item}}">
          <view class="bag-icon">{{item.icon || 'ğŸ“¦'}}</view>
          <view class="bag-info">
            <text class="bag-name">{{item.name}}</text>
            <text class="bag-level">Lv.{{item.level || 1}}</text>
          </view>
          <view class="bag-attrs">
            <text wx:if="{{item.baseAttributes.attack}}">æ”»+{{item.baseAttributes.attack}}</text>
            <text wx:if="{{item.baseAttributes.defense}}">é˜²+{{item.baseAttributes.defense}}</text>
          </view>
        </view>
        <view class="empty-bag" wx:if="{{bagEquipments.length === 0}}">
          <text>èƒŒåŒ…ä¸­æ²¡æœ‰å¯ç”¨è£…å¤‡</text>
          <text class="hint">å»ç§˜å¢ƒæ¢ç´¢æˆ–å‰¯æœ¬è·å–</text>
        </view>
      </scroll-view>
    </view>
  </view>
  
  <!-- è£…å¤‡è¯¦æƒ…å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showDetailModal}}" catchtap="closeDetailModal">
    <view class="modal-content detail-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title {{selectedEquipment.qualityClass}}">{{selectedEquipment.name}}</text>
        <view class="close-btn" bindtap="closeDetailModal">âœ•</view>
      </view>
      
      <view class="detail-body">
        <view class="detail-icon-wrap {{selectedEquipment.qualityClass}}">
          <text class="detail-icon">{{selectedEquipment.icon || 'âš”ï¸'}}</text>
          <text class="detail-enhance" wx:if="{{selectedEquipment.enhanceLevel}}">+{{selectedEquipment.enhanceLevel}}</text>
        </view>
        
        <view class="detail-meta">
          <text class="meta-item">ç­‰çº§: Lv.{{selectedEquipment.level || 1}}</text>
          <text class="meta-item">å“è´¨: {{selectedEquipment.quality.name || 'æ™®é€š'}}</text>
          <text class="meta-item" wx:if="{{selectedEquipment.setInfo}}">å¥—è£…: {{selectedEquipment.setInfo.setName}}</text>
        </view>
        
        <view class="detail-attrs">
          <view class="attr-title">å±æ€§åŠ æˆ</view>
          <view class="attr-grid">
            <text wx:if="{{selectedEquipment.baseAttributes.attack}}">æ”»å‡» +{{selectedEquipment.baseAttributes.attack}}</text>
            <text wx:if="{{selectedEquipment.baseAttributes.defense}}">é˜²å¾¡ +{{selectedEquipment.baseAttributes.defense}}</text>
            <text wx:if="{{selectedEquipment.baseAttributes.valor}}">æ­¦å‹‡ +{{selectedEquipment.baseAttributes.valor}}</text>
            <text wx:if="{{selectedEquipment.baseAttributes.command}}">ç»Ÿå¾¡ +{{selectedEquipment.baseAttributes.command}}</text>
            <text wx:if="{{selectedEquipment.baseAttributes.mobility}}">æœºåŠ¨ +{{selectedEquipment.baseAttributes.mobility}}</text>
            <text wx:if="{{selectedEquipment.baseAttributes.hp}}">ç”Ÿå‘½ +{{selectedEquipment.baseAttributes.hp}}</text>
          </view>
        </view>
        
        <view class="detail-desc" wx:if="{{selectedEquipment.description}}">
          <text>{{selectedEquipment.description}}</text>
        </view>
      </view>
      
      <view class="detail-actions">
        <view class="action-btn change" bindtap="changeEquipment">æ›´æ¢</view>
        <view class="action-btn enhance" bindtap="openEnhanceModal">å¼ºåŒ–</view>
        <view class="action-btn unequip" bindtap="unequipItem">å¸ä¸‹</view>
      </view>
    </view>
  </view>
  
  <!-- å¼ºåŒ–å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showEnhanceModal}}" catchtap="closeEnhanceModal">
    <view class="modal-content enhance-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">è£…å¤‡å¼ºåŒ–</text>
        <view class="close-btn" bindtap="closeEnhanceModal">âœ•</view>
      </view>
      
      <view class="enhance-body">
        <!-- è£…å¤‡å±•ç¤º -->
        <view class="enhance-equip {{enhanceEquipment.qualityClass}}">
          <text class="equip-icon">{{enhanceEquipment.icon || 'âš”ï¸'}}</text>
          <text class="equip-name">{{enhanceEquipment.name}}</text>
          <text class="equip-level">+{{enhanceEquipment.enhanceLevel || 0}}</text>
        </view>
        
        <!-- å¼ºåŒ–æ•ˆæœé¢„è§ˆ -->
        <view class="enhance-preview">
          <text class="preview-title">å¼ºåŒ–åå±æ€§æå‡</text>
          <view class="preview-grid">
            <text>æ”»å‡» +10%</text>
            <text>é˜²å¾¡ +10%</text>
          </view>
          <view class="preview-special" wx:if="{{(enhanceEquipment.enhanceLevel || 0) >= 4}}">
            <text>æœºåŠ¨æ€§ +{{(enhanceEquipment.enhanceLevel || 0) >= 10 ? 8 : ((enhanceEquipment.enhanceLevel || 0) >= 8 ? 4 : ((enhanceEquipment.enhanceLevel || 0) >= 6 ? 2 : 1))}}</text>
          </view>
        </view>
        
        <!-- å¼ºåŒ–çŸ³é€‰æ‹© -->
        <view class="stone-section">
          <text class="section-title">é€‰æ‹©å¼ºåŒ–çŸ³</text>
          <scroll-view class="stone-list" scroll-x>
            <view class="stone-item {{selectedStone && selectedStone.itemId === item.itemId ? 'selected' : ''}}"
                  wx:for="{{enhanceStones}}" wx:key="itemId"
                  bindtap="selectEnhanceStone" data-stone="{{item}}">
              <text class="stone-icon">{{item.icon || 'ğŸ’'}}</text>
              <text class="stone-name">{{item.name}}</text>
              <text class="stone-count">x{{item.count}}</text>
            </view>
            <view class="no-stones" wx:if="{{enhanceStones.length === 0}}">
              <text>æ²¡æœ‰å¼ºåŒ–çŸ³</text>
            </view>
          </scroll-view>
        </view>
        
        <!-- æˆåŠŸç‡ -->
        <view class="success-rate">
          <text>æˆåŠŸç‡: 70%</text>
        </view>
      </view>
      
      <view class="enhance-actions">
        <view class="enhance-btn {{!selectedStone ? 'disabled' : ''}}" bindtap="doEnhance">
          å¼ºåŒ–
        </view>
      </view>
    </view>
  </view>
</view>
