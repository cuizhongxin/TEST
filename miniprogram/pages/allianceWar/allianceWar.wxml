<!-- pages/allianceWar/allianceWar.wxml -->
<view class="war-page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="header">
    <view class="header-back" bindtap="goBack">è¿”å›</view>
    <view class="header-title">ç›Ÿæˆ˜</view>
    <view class="header-status {{status}}">
      <text wx:if="{{status === 'NOT_STARTED'}}">æœªå¼€å§‹</text>
      <text wx:elif="{{status === 'REGISTERING'}}">æŠ¥åä¸­</text>
      <text wx:elif="{{status === 'IN_PROGRESS'}}">è¿›è¡Œä¸­</text>
      <text wx:else>å·²ç»“æŸ</text>
    </view>
  </view>

  <!-- æ ‡ç­¾æ  -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">ç›Ÿæˆ˜ä¿¡æ¯</view>
    <view class="tab-item {{currentTab === 'participants' ? 'active' : ''}}" bindtap="switchTab" data-tab="participants">å‚æˆ˜åå•</view>
    <view class="tab-item {{currentTab === 'battles' ? 'active' : ''}}" bindtap="switchTab" data-tab="battles">å¯¹æˆ˜è®°å½•</view>
    <view class="tab-item {{currentTab === 'rankings' ? 'active' : ''}}" bindtap="switchTab" data-tab="rankings">æ’åå¥–åŠ±</view>
  </view>

  <!-- å†…å®¹åŒº -->
  <scroll-view class="content" scroll-y>
    
    <!-- ç›Ÿæˆ˜ä¿¡æ¯æ ‡ç­¾ -->
    <view class="tab-content" wx:if="{{currentTab === 'info'}}">
      <!-- ç›Ÿæˆ˜è§„åˆ™ -->
      <view class="section rules-section">
        <view class="section-title">âš”ï¸ ç›Ÿæˆ˜è§„åˆ™</view>
        <view class="rules-list">
          <view class="rule-item">
            <view class="rule-icon">ğŸ•</view>
            <view class="rule-text">
              <text class="rule-title">æŠ¥åæ—¶é—´</text>
              <text class="rule-desc">æ¯æ—¥ 20:45 - 21:00</text>
            </view>
          </view>
          <view class="rule-item">
            <view class="rule-icon">âš”ï¸</view>
            <view class="rule-text">
              <text class="rule-title">æˆ˜æ–—æ—¶é—´</text>
              <text class="rule-desc">æ¯æ—¥ 21:00 å¼€å§‹</text>
            </view>
          </view>
          <view class="rule-item">
            <view class="rule-icon">ğŸ¯</view>
            <view class="rule-text">
              <text class="rule-title">é…å¯¹è§„åˆ™</text>
              <text class="rule-desc">åŒè”ç›Ÿä¸é…å¯¹ï¼Œèƒœè€…æ™‹çº§</text>
            </view>
          </view>
          <view class="rule-item">
            <view class="rule-icon">ğŸ†</view>
            <view class="rule-text">
              <text class="rule-title">èƒœåˆ©æ¡ä»¶</text>
              <text class="rule-desc">å‰©ä½™ç©å®¶åŒè”ç›Ÿæ—¶ç»“æŸ</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å½“å‰çŠ¶æ€ -->
      <view class="section status-section">
        <view class="section-title">ğŸ“Š å½“å‰çŠ¶æ€</view>
        <view class="status-info">
          <view class="status-row">
            <text class="status-label">æˆ˜æ–—æ—¥æœŸ:</text>
            <text class="status-value">{{war.date || 'ä»Šæ—¥'}}</text>
          </view>
          <view class="status-row">
            <text class="status-label">å½“å‰è½®æ¬¡:</text>
            <text class="status-value">ç¬¬ {{war.currentRound || 0}} è½®</text>
          </view>
          <view class="status-row">
            <text class="status-label">å‚æˆ˜äººæ•°:</text>
            <text class="status-value">{{participants.length}} äºº</text>
          </view>
          <view class="status-row" wx:if="{{registered && myParticipant}}">
            <text class="status-label">æˆ‘çš„çŠ¶æ€:</text>
            <text class="status-value highlight">
              {{myParticipant.status === 'WAITING' ? 'ç­‰å¾…é…å¯¹' : 
                myParticipant.status === 'IN_BATTLE' ? 'æˆ˜æ–—ä¸­' : 
                myParticipant.status === 'SPECTATING' ? 'å·²æ·˜æ±°' : 'èƒœåˆ©è€…'}}
            </text>
          </view>
          <view class="status-row" wx:if="{{registered && myParticipant}}">
            <text class="status-label">æˆ‘çš„ç¼–å·:</text>
            <text class="status-value">{{myParticipant.playerNumber}} å·</text>
          </view>
          <view class="status-row" wx:if="{{registered && myParticipant}}">
            <text class="status-label">èƒœ/è´Ÿ/æ——:</text>
            <text class="status-value">{{myParticipant.wins}} / {{myParticipant.losses}} / {{myParticipant.flags}}</text>
          </view>
        </view>
      </view>

      <!-- æŠ¥ååŒºåŸŸ -->
      <view class="section register-section">
        <view class="section-title">ğŸ“ ç›Ÿæˆ˜æŠ¥å</view>
        
        <view class="register-area" wx:if="{{status === 'NOT_STARTED'}}">
          <view class="register-tip">ç›Ÿæˆ˜æŠ¥åå°†äº 20:45 å¼€å§‹</view>
          <!-- æµ‹è¯•æŒ‰é’® -->
          <view class="test-buttons">
            <view class="btn-test" bindtap="triggerRegistration">å¼€å¯æŠ¥å(æµ‹è¯•)</view>
          </view>
        </view>
        
        <view class="register-area" wx:elif="{{status === 'REGISTERING'}}">
          <view class="register-tip" wx:if="{{!registered}}">æŠ¥åä¸­ï¼æˆ˜æ–—å°†äº 21:00 å¼€å§‹</view>
          <view class="register-tip success" wx:else>æ‚¨å·²æˆåŠŸæŠ¥åï¼Œç¼–å·: {{myParticipant.playerNumber}}</view>
          
          <view class="btn-register" bindtap="register" wx:if="{{!registered}}">ç«‹å³æŠ¥å</view>
          <view class="btn-cancel-register" bindtap="cancelRegister" wx:else>å–æ¶ˆæŠ¥å</view>
          
          <!-- æµ‹è¯•æŒ‰é’® -->
          <view class="test-buttons">
            <view class="btn-test" bindtap="triggerBattle">å¼€å§‹æˆ˜æ–—(æµ‹è¯•)</view>
          </view>
        </view>
        
        <view class="register-area" wx:elif="{{status === 'IN_PROGRESS'}}">
          <view class="register-tip battle">âš”ï¸ æˆ˜æ–—è¿›è¡Œä¸­...</view>
          <view class="my-status" wx:if="{{registered && myParticipant}}">
            <text wx:if="{{myParticipant.status === 'WAITING'}}">ğŸ¯ ç­‰å¾…ä¸‹ä¸€è½®é…å¯¹</text>
            <text wx:elif="{{myParticipant.status === 'IN_BATTLE'}}">âš”ï¸ æ‚¨æ­£åœ¨æˆ˜æ–—ä¸­</text>
            <text wx:elif="{{myParticipant.status === 'SPECTATING'}}">ğŸ‘€ æ‚¨å·²è¿›å…¥è§‚æˆ˜å¸­</text>
            <text wx:else>ğŸ† æ‚¨æ˜¯æœ€ç»ˆèƒœåˆ©è€…ï¼</text>
          </view>
          <view class="register-tip" wx:if="{{!registered}}">
            æœ¬åœºç›Ÿæˆ˜æ‚¨æœªå‚åŠ 
          </view>
        </view>
        
        <view class="register-area" wx:else>
          <view class="register-tip finished">ğŸ ç›Ÿæˆ˜å·²ç»“æŸ</view>
          <view class="btn-view-result" bindtap="switchTab" data-tab="rankings">æŸ¥çœ‹æ’å</view>
          <!-- æµ‹è¯•æŒ‰é’® -->
          <view class="test-buttons">
            <view class="btn-test" bindtap="resetWar">é‡ç½®ç›Ÿæˆ˜(æµ‹è¯•)</view>
          </view>
        </view>
      </view>

      <!-- å¥–åŠ±è¯´æ˜ -->
      <view class="section rewards-section">
        <view class="section-title">ğŸ å¥–åŠ±è¯´æ˜</view>
        <view class="rewards-list">
          <view class="reward-item">
            <view class="reward-title">ğŸ–ï¸ å‚æˆ˜å¥–åŠ±</view>
            <view class="reward-desc">æ‰€æœ‰å‚æˆ˜å›ä¸»è‡ªåŠ¨è·å¾—"ç›Ÿæˆ˜ç¤¼ç›’"</view>
          </view>
          <view class="reward-item">
            <view class="reward-title">ğŸ¥‡ ä¸ªäººæ’å</view>
            <view class="reward-desc">å‰5åè·å¾—"ç›Ÿæˆ˜å®ç®±"ç­‰ä¸°åšå¥–åŠ±</view>
          </view>
          <view class="reward-item">
            <view class="reward-title">ğŸ° è”ç›Ÿæ’å</view>
            <view class="reward-desc">å‰3åè”ç›Ÿè·å¾—å®ç®±å’Œé«˜çº§é“å…·</view>
          </view>
          <view class="reward-item">
            <view class="reward-title">ğŸš© å†›æ——å¥–åŠ±</view>
            <view class="reward-desc">æ¯å¤ºå–1é¢å†›æ——ï¼Œè”ç›Ÿé¢å¤–è·å¾—èµ„æº</view>
          </view>
        </view>
      </view>
    </view>

    <!-- å‚æˆ˜åå•æ ‡ç­¾ -->
    <view class="tab-content" wx:if="{{currentTab === 'participants'}}">
      <view class="section">
        <view class="section-title">ğŸ‘¥ å‚æˆ˜åå• ({{participants.length}}äºº)</view>
        <view class="participants-list">
          <view class="participant-header">
            <text class="col-num">ç¼–å·</text>
            <text class="col-name">ç©å®¶</text>
            <text class="col-alliance">è”ç›Ÿ</text>
            <text class="col-status">çŠ¶æ€</text>
            <text class="col-score">æˆ˜ç»©</text>
          </view>
          <view class="participant-item {{item.odUserId === myParticipant.odUserId ? 'is-me' : ''}}" 
                wx:for="{{participants}}" wx:key="odUserId">
            <text class="col-num">{{item.playerNumber}}</text>
            <text class="col-name {{item.faction === 'èœ€' ? 'shu' : item.faction === 'é­' ? 'wei' : 'wu'}}">{{item.playerName}}</text>
            <text class="col-alliance">{{item.allianceName}}</text>
            <text class="col-status {{item.status}}">
              {{item.status === 'WAITING' ? 'ç­‰å¾…' : 
                item.status === 'IN_BATTLE' ? 'æˆ˜æ–—' : 
                item.status === 'SPECTATING' ? 'æ·˜æ±°' : 'èƒœåˆ©'}}
            </text>
            <text class="col-score">{{item.wins}}/{{item.losses}}</text>
          </view>
          <view class="empty-state" wx:if="{{participants.length === 0}}">
            <text>æš‚æ— å‚æˆ˜ç©å®¶</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å¯¹æˆ˜è®°å½•æ ‡ç­¾ -->
    <view class="tab-content" wx:if="{{currentTab === 'battles'}}">
      <!-- æˆ‘çš„å¯¹æˆ˜ -->
      <view class="section" wx:if="{{myBattles.length > 0}}">
        <view class="section-title">ğŸ¯ æˆ‘çš„å¯¹æˆ˜</view>
        <view class="battles-list">
          <view class="battle-item" wx:for="{{myBattles}}" wx:key="id">
            <view class="battle-round">ç¬¬{{item.round}}è½®</view>
            <view class="battle-players">
              <view class="battle-player {{item.winnerId === item.player1Id ? 'winner' : 'loser'}}">
                <text class="player-name">{{item.player1Name}}</text>
                <text class="player-score">{{item.player1Score}}åˆ†</text>
              </view>
              <view class="battle-vs">VS</view>
              <view class="battle-player {{item.winnerId === item.player2Id ? 'winner' : 'loser'}}">
                <text class="player-name">{{item.player2Name}}</text>
                <text class="player-score">{{item.player2Score}}åˆ†</text>
              </view>
            </view>
            <view class="battle-result">
              èƒœè€…: <text class="winner-name">{{item.winnerName}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å…¨éƒ¨å¯¹æˆ˜ -->
      <view class="section">
        <view class="section-title">ğŸ“œ å…¨éƒ¨å¯¹æˆ˜è®°å½•</view>
        <view class="battles-list">
          <view class="battle-item" wx:for="{{allBattles}}" wx:key="id">
            <view class="battle-round">ç¬¬{{item.round}}è½®</view>
            <view class="battle-players">
              <view class="battle-player {{item.winnerId === item.player1Id ? 'winner' : 'loser'}}">
                <text class="player-name">{{item.player1Name}}</text>
                <text class="player-alliance">({{item.player1Alliance}})</text>
              </view>
              <view class="battle-vs">{{item.player1Score}} : {{item.player2Score}}</view>
              <view class="battle-player {{item.winnerId === item.player2Id ? 'winner' : 'loser'}}">
                <text class="player-name">{{item.player2Name}}</text>
                <text class="player-alliance">({{item.player2Alliance}})</text>
              </view>
            </view>
          </view>
          <view class="empty-state" wx:if="{{allBattles.length === 0}}">
            <text>æš‚æ— å¯¹æˆ˜è®°å½•</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æ’åå¥–åŠ±æ ‡ç­¾ -->
    <view class="tab-content" wx:if="{{currentTab === 'rankings'}}">
      <!-- è”ç›Ÿæ’å -->
      <view class="section">
        <view class="section-title">ğŸ° è”ç›Ÿæ’å</view>
        <view class="ranking-list">
          <view class="ranking-header">
            <text class="col-rank">æ’å</text>
            <text class="col-name">è”ç›Ÿ</text>
            <text class="col-flags">å†›æ——</text>
            <text class="col-members">äººæ•°</text>
            <text class="col-wins">èƒœåœº</text>
          </view>
          <view class="ranking-item rank-{{item.rank}}" wx:for="{{allianceRanks}}" wx:key="allianceId">
            <text class="col-rank">
              <text wx:if="{{item.rank === 1}}">ğŸ¥‡</text>
              <text wx:elif="{{item.rank === 2}}">ğŸ¥ˆ</text>
              <text wx:elif="{{item.rank === 3}}">ğŸ¥‰</text>
              <text wx:else>{{item.rank}}</text>
            </text>
            <text class="col-name {{item.faction === 'èœ€' ? 'shu' : item.faction === 'é­' ? 'wei' : 'wu'}}">{{item.allianceName}}</text>
            <text class="col-flags">{{item.totalFlags}}</text>
            <text class="col-members">{{item.participantCount}}</text>
            <text class="col-wins">{{item.wins}}</text>
          </view>
          <view class="empty-state" wx:if="{{allianceRanks.length === 0}}">
            <text>ç›Ÿæˆ˜ç»“æŸåæ˜¾ç¤ºæ’å</text>
          </view>
        </view>
      </view>
      
      <!-- ä¸ªäººæ’å -->
      <view class="section">
        <view class="section-title">ğŸ‘¤ ä¸ªäººæ’å</view>
        <view class="ranking-list">
          <view class="ranking-header">
            <text class="col-rank">æ’å</text>
            <text class="col-name">ç©å®¶</text>
            <text class="col-alliance">è”ç›Ÿ</text>
            <text class="col-wins">èƒœåœº</text>
            <text class="col-flags">å†›æ——</text>
          </view>
          <view class="ranking-item rank-{{item.rank}} {{item.odUserId === myParticipant.odUserId ? 'is-me' : ''}}" 
                wx:for="{{playerRanks}}" wx:key="odUserId">
            <text class="col-rank">
              <text wx:if="{{item.rank === 1}}">ğŸ¥‡</text>
              <text wx:elif="{{item.rank === 2}}">ğŸ¥ˆ</text>
              <text wx:elif="{{item.rank === 3}}">ğŸ¥‰</text>
              <text wx:else>{{item.rank}}</text>
            </text>
            <text class="col-name">{{item.playerName}}</text>
            <text class="col-alliance">{{item.allianceName}}</text>
            <text class="col-wins">{{item.wins}}</text>
            <text class="col-flags">{{item.flags}}</text>
          </view>
          <view class="empty-state" wx:if="{{playerRanks.length === 0}}">
            <text>ç›Ÿæˆ˜ç»“æŸåæ˜¾ç¤ºæ’å</text>
          </view>
        </view>
      </view>
      
      <!-- å¥–åŠ±å±•ç¤º -->
      <view class="section" wx:if="{{allianceRanks.length > 0}}">
        <view class="section-title">ğŸ è·å¾—å¥–åŠ±</view>
        <view class="rewards-detail">
          <view class="reward-group" wx:for="{{allianceRanks}}" wx:key="allianceId" wx:if="{{index < 5}}">
            <view class="reward-group-title">
              <text wx:if="{{item.rank === 1}}">ğŸ¥‡ ç¬¬1å: {{item.allianceName}}</text>
              <text wx:elif="{{item.rank === 2}}">ğŸ¥ˆ ç¬¬2å: {{item.allianceName}}</text>
              <text wx:elif="{{item.rank === 3}}">ğŸ¥‰ ç¬¬3å: {{item.allianceName}}</text>
              <text wx:else>ç¬¬{{item.rank}}å: {{item.allianceName}}</text>
            </view>
            <view class="reward-items">
              <text class="reward-tag" wx:for="{{item.rewards}}" wx:key="*this" wx:for-item="reward">{{reward}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

  </scroll-view>
</view>
