<wxs module="utils">
  // è·å–å›½å®¶åç§°
  function getNationName(nationId) {
    if (nationId === 'WEI') return 'é­';
    if (nationId === 'SHU') return 'èœ€';
    if (nationId === 'WU') return 'å´';
    return 'æœªçŸ¥';
  }
  
  // è·å–å›½å®¶ç´¢å¼•
  function getNationIndex(nationId) {
    if (nationId === 'WEI') return 0;
    if (nationId === 'SHU') return 1;
    if (nationId === 'WU') return 2;
    return 0;
  }
  
  // è·å–å›½å®¶é¢œè‰²
  function getNationColor(nations, nationId) {
    if (!nations || !nations.length) return '#666';
    var idx = getNationIndex(nationId);
    return nations[idx] && nations[idx].color ? nations[idx].color : '#666';
  }
  
  // æ ¼å¼åŒ–åŠ æˆç™¾åˆ†æ¯”
  function formatBonus(rate) {
    if (!rate || rate <= 1) return '0';
    return Math.floor((rate - 1) * 100);
  }
  
  module.exports = {
    getNationName: getNationName,
    getNationIndex: getNationIndex,
    getNationColor: getNationColor,
    formatBonus: formatBonus
  };
</wxs>

<view class="nation-war-page">
  <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
  <view class="top-bar">
    <view class="back-btn" bindtap="goBack">
      <text>â—€ è¿”å›</text>
    </view>
    
    <view class="time-info">
      <view class="time-item">
        <text class="time-label">æŠ¥åæ—¶é—´</text>
        <text class="time-value">{{signUpTime}}</text>
      </view>
      <view class="time-item">
        <text class="time-label">æˆ˜æ–—æ—¶é—´</text>
        <text class="time-value">{{battleTime}}</text>
      </view>
      <view class="status-badge status-{{timeStatus}}">
        <text wx:if="{{timeStatus === 'preparing'}}">å‡†å¤‡ä¸­</text>
        <text wx:elif="{{timeStatus === 'signup'}}">æŠ¥åä¸­</text>
        <text wx:elif="{{timeStatus === 'fighting'}}">æˆ˜æ–—ä¸­</text>
        <text wx:else>å·²ç»“æŸ</text>
      </view>
    </view>
    
    <view class="player-info">
      <view class="nation-badge" wx:if="{{playerNation}}" 
            style="background: {{utils.getNationColor(nations, playerNation)}}">
        <text>{{utils.getNationName(playerNation)}}</text>
      </view>
      <view class="merit-info" bindtap="openExchange">
        <text class="merit-icon">ğŸ–ï¸</text>
        <text class="merit-value">{{playerMerit}}</text>
      </view>
    </view>
  </view>
  
  <!-- åœ°å›¾åŒºåŸŸ -->
  <view class="map-container">
    <!-- èƒŒæ™¯ -->
    <view class="map-bg"></view>
    
    <!-- å›½å®¶åŒºåŸŸ -->
    <view class="nation-area wei-area">
      <text class="area-name">é­</text>
    </view>
    <view class="nation-area shu-area">
      <text class="area-name">èœ€</text>
    </view>
    <view class="nation-area wu-area">
      <text class="area-name">å´</text>
    </view>
    
    <!-- åŸå¸‚ -->
    <view class="city-node {{city.isCapital ? 'capital' : ''}} {{city.owner === playerNation ? 'own' : 'enemy'}}"
          wx:for="{{cities}}" wx:key="id" wx:for-item="city"
          style="left: {{city.x}}rpx; top: {{city.y}}rpx; background: {{utils.getNationColor(nations, city.owner)}}"
          bindtap="onCityTap" data-city="{{city.id}}">
      <view class="city-icon">{{city.isCapital ? 'ğŸ¯' : 'ğŸ '}}</view>
      <view class="city-name">{{city.name}}</view>
      <view class="attack-indicator" wx:if="{{attackableCities && attackableCities.length > 0}}">
        <text wx:for="{{attackableCities}}" wx:key="id" wx:if="{{item.id === city.id}}">âš”ï¸</text>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨å›¾ä¾‹ -->
  <view class="legend-bar">
    <view class="legend-item" wx:for="{{nations}}" wx:key="id">
      <view class="legend-color" style="background: {{item.color}}"></view>
      <text>{{item.name}} ({{item.cities.length}}åŸ)</text>
    </view>
    <view class="legend-item">
      <text>ğŸ¯ å›½éƒ½</text>
    </view>
    <view class="legend-item">
      <text>âš”ï¸ å¯è¿›æ”»</text>
    </view>
  </view>
  
  <!-- é€‰æ‹©å›½å®¶å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showSelectNation}}" catchtouchmove="true">
    <view class="modal-content nation-select-modal">
      <view class="modal-title">é€‰æ‹©é˜µè¥</view>
      <view class="modal-desc">è¯·é€‰æ‹©ä½ è¦æ•ˆå¿ çš„å›½å®¶ï¼Œä¸€æ—¦é€‰æ‹©ä¸å¯æ›´æ”¹</view>
      
      <view class="nation-list">
        <view class="nation-option" wx:for="{{nations}}" wx:key="id"
              style="border-color: {{item.color}}"
              bindtap="selectNation" data-nation="{{item.id}}">
          <view class="nation-flag" style="background: {{item.color}}">
            <text>{{item.name}}</text>
          </view>
          <view class="nation-info">
            <text class="nation-name">{{item.name}}å›½</text>
            <text class="nation-capital">å›½éƒ½ï¼š{{item.capitalName}}</text>
            <text class="nation-cities">åŸå¸‚ï¼š{{item.cities.length}}åº§</text>
          </view>
        </view>
      </view>
    </view>
  </view>
  
  <!-- åŸå¸‚è¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showCityDetail}}" bindtap="closeCityDetail">
    <view class="modal-content city-detail-modal" catchtap="">
      <view class="modal-close" bindtap="closeCityDetail">âœ•</view>
      
      <view class="city-header">
        <view class="city-icon-large">{{selectedCity.isCapital ? 'ğŸ¯' : 'ğŸ '}}</view>
        <view class="city-title">
          <text class="city-name-large">{{selectedCity.name}}</text>
          <view class="city-owner" 
                style="background: {{utils.getNationColor(nations, selectedCity.owner)}}">
            <text>{{utils.getNationName(selectedCity.owner)}}å›½é¢†åœŸ</text>
          </view>
        </view>
      </view>
      
      <view class="city-stats">
        <view class="stat-item">
          <text class="stat-label">é˜²å¾¡åŠ æˆ</text>
          <text class="stat-value">+{{selectedCity.defenseBonus || 0}}%</text>
        </view>
        <view class="stat-item" wx:if="{{selectedCity.isCapital}}">
          <text class="stat-label">ç±»å‹</text>
          <text class="stat-value capital-tag">å›½éƒ½</text>
        </view>
      </view>
      
      <!-- å›½æˆ˜çŠ¶æ€ -->
      <view class="war-status-section" wx:if="{{cityWarStatus && cityWarStatus.hasWar}}">
        <view class="section-title">ä»Šæ—¥å›½æˆ˜</view>
        <view class="war-info">
          <view class="war-stat">
            <text class="war-label">è¿›æ”»æ–¹</text>
            <text class="war-value">{{utils.getNationName(currentWar.attackNation)}} ({{currentWar.attackers.length}}äºº)</text>
          </view>
          <view class="war-stat">
            <text class="war-label">é˜²å®ˆæ–¹</text>
            <text class="war-value">{{utils.getNationName(currentWar.defendNation)}} ({{currentWar.defenders.length}}äºº)</text>
          </view>
          <view class="war-stat" wx:if="{{currentWar.status === 'FIGHTING' || currentWar.status === 'FINISHED'}}">
            <text class="war-label">ç§¯åˆ†</text>
            <text class="war-value">{{currentWar.attackScore}} : {{currentWar.defendScore}}</text>
          </view>
          <view class="war-stat" wx:if="{{currentWar.status === 'FINISHED' && currentWar.winner}}">
            <text class="war-label">èƒœåˆ©æ–¹</text>
            <text class="war-value winner">{{utils.getNationName(currentWar.winner)}}</text>
          </view>
        </view>
        
        <view class="war-actions">
          <button class="action-btn view-btn" bindtap="viewWarDetail" 
                  wx:if="{{currentWar.status === 'FINISHED'}}">
            æŸ¥çœ‹æˆ˜æŠ¥
          </button>
          <button class="action-btn test-btn" bindtap="testStartWar"
                  wx:if="{{currentWar.status === 'SIGN_UP'}}">
            [æµ‹è¯•]å¼€å§‹æˆ˜æ–—
          </button>
        </view>
      </view>
      
      <!-- æŠ¥ååŒºåŸŸ -->
      <view class="signup-section" wx:if="{{selectedCity.owner !== playerNation && timeStatus === 'signup'}}">
        <button class="signup-btn" bindtap="openSignUp"
                wx:if="{{attackableCities && attackableCities.length > 0}}"
                disabled="{{!canAttackSelectedCity}}">
          æŠ¥åè¿›æ”»
        </button>
        <view class="signup-hint" wx:if="{{!canAttackSelectedCity}}">
          è¯¥åŸå¸‚ä¸æœ¬å›½é¢†åœŸä¸æ¥å£¤ï¼Œæ— æ³•è¿›æ”»
        </view>
      </view>
      
      <view class="own-city-hint" wx:if="{{selectedCity.owner === playerNation}}">
        <text>æœ¬å›½é¢†åœŸï¼Œæ— éœ€è¿›æ”»</text>
      </view>
    </view>
  </view>
  
  <!-- æŠ¥åç¡®è®¤å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showSignUp}}" bindtap="closeSignUp">
    <view class="modal-content signup-modal" catchtap="">
      <view class="modal-close" bindtap="closeSignUp">âœ•</view>
      <view class="modal-title">æŠ¥åå›½æˆ˜</view>
      
      <view class="signup-info">
        <view class="info-row">
          <text class="info-label">ç›®æ ‡åŸå¸‚</text>
          <text class="info-value">{{selectedCity.name}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">é˜²å®ˆæ–¹</text>
          <text class="info-value">{{utils.getNationName(selectedCity.owner)}}å›½</text>
        </view>
        <view class="info-row">
          <text class="info-label">æ‚¨çš„æˆ˜åŠ›</text>
          <text class="info-value">{{playerPower}}</text>
        </view>
      </view>
      
      <view class="signup-rules">
        <view class="rule-item">âš”ï¸ æŠ¥åäººæ•°è¾¾åˆ°10äººå³å¯è·å¾—è¿›æ”»æƒ</view>
        <view class="rule-item">ğŸ–ï¸ æˆ˜æ–—ä¸­å¯è·å¾—å†›åŠŸå¥–åŠ±</view>
        <view class="rule-item">ğŸ† èƒœåˆ©æ–¹å°†å é¢†è¯¥åŸå¸‚</view>
      </view>
      
      <button class="confirm-btn" bindtap="doSignUp">ç¡®è®¤æŠ¥å</button>
    </view>
  </view>
  
  <!-- å†›åŠŸå…‘æ¢å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showExchange}}" bindtap="closeExchange">
    <view class="modal-content exchange-modal" catchtap="">
      <view class="modal-close" bindtap="closeExchange">âœ•</view>
      <view class="modal-title">å†›åŠŸå…‘æ¢</view>
      
      <view class="merit-display">
        <text class="merit-label">å½“å‰å†›åŠŸ</text>
        <view class="merit-amount">
          <text class="merit-icon-lg">ğŸ–ï¸</text>
          <text class="merit-num">{{playerMerit}}</text>
        </view>
      </view>
      
      <view class="exchange-rate-info">
        <text>å…‘æ¢æ¯”ä¾‹ï¼š1å†›åŠŸ = {{silverPerMerit}}ç™½é“¶</text>
        <text class="rate-tip" wx:if="{{exchangeRate > 1}}">
          (æœ¬å›½å é¢†{{playerNationCityCount}}åŸï¼Œ+{{exchangeRateBonus}}%åŠ æˆ)
        </text>
      </view>
      
      <view class="exchange-input">
        <text class="input-label">å…‘æ¢æ•°é‡</text>
        <input type="number" class="amount-input" 
               value="{{exchangeAmount}}" 
               bindinput="onExchangeAmountChange"
               placeholder="è¾“å…¥å†›åŠŸæ•°é‡" />
      </view>
      
      <view class="quick-select">
        <button class="quick-btn" bindtap="quickSelectAmount" data-ratio="0.25">25%</button>
        <button class="quick-btn" bindtap="quickSelectAmount" data-ratio="0.5">50%</button>
        <button class="quick-btn" bindtap="quickSelectAmount" data-ratio="0.75">75%</button>
        <button class="quick-btn" bindtap="quickSelectAmount" data-ratio="1">å…¨éƒ¨</button>
      </view>
      
      <view class="exchange-preview">
        <text>é¢„è®¡è·å¾—ï¼š</text>
        <text class="silver-amount">{{expectedSilver}} ç™½é“¶</text>
      </view>
      
      <button class="confirm-btn" bindtap="doExchange" 
              disabled="{{exchangeAmount <= 0 || exchangeAmount > playerMerit}}">
        ç¡®è®¤å…‘æ¢
      </button>
    </view>
  </view>
  
  <!-- æˆ˜æ–—ç»“æœå¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showWarResult}}" bindtap="closeWarResult">
    <view class="modal-content war-result-modal" catchtap="">
      <view class="modal-close" bindtap="closeWarResult">âœ•</view>
      <view class="modal-title">æˆ˜æŠ¥</view>
      
      <view class="result-header" wx:if="{{warResult}}">
        <view class="result-side attack-side">
          <text class="side-name">{{utils.getNationName(warResult.attackNation)}}</text>
          <text class="side-score">{{warResult.attackScore}}</text>
        </view>
        <view class="result-vs">VS</view>
        <view class="result-side defend-side">
          <text class="side-name">{{utils.getNationName(warResult.defendNation)}}</text>
          <text class="side-score">{{warResult.defendScore}}</text>
        </view>
      </view>
      
      <view class="result-winner" wx:if="{{warResult && warResult.winner}}">
        <text>ğŸ† {{utils.getNationName(warResult.winner)}}å›½ è·èƒœï¼</text>
      </view>
      
      <view class="battle-list" wx:if="{{warResult && warResult.battles && warResult.battles.length > 0}}">
        <view class="section-title">æˆ˜æ–—è®°å½•</view>
        <scroll-view scroll-y class="battle-scroll">
          <view class="battle-item" wx:for="{{warResult.battles}}" wx:key="battleId">
            <text class="battle-round">ç¬¬{{item.round}}è½®</text>
            <view class="battle-detail">
              <text class="fighter">{{item.attackerName}}</text>
              <text class="vs-small">VS</text>
              <text class="fighter">{{item.defenderName}}</text>
            </view>
            <text class="battle-result">èƒœè€…ï¼š{{item.winnerName}} (+{{item.scoreGained}}åˆ†)</text>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</view>
