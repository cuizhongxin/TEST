<!--pages/character/character.wxml - å°†é¢†è¯¦æƒ…é¡µ-->
<view class="page-container">
  <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
  <view class="tabs">
    <view class="tab-item {{activeTab === 'list' ? 'active' : ''}}" bindtap="switchTab" data-tab="list">
      <text>å°†é¢†åˆ—è¡¨</text>
    </view>
    <view class="tab-item {{activeTab === 'detail' ? 'active' : ''}}" bindtap="switchTab" data-tab="detail">
      <text>å°†é¢†è£…å¤‡</text>
    </view>
    <view class="tab-item {{activeTab === 'inherit' ? 'active' : ''}}" bindtap="switchTab" data-tab="inherit">
      <text>å°†é¢†ä¼ æ‰¿</text>
    </view>
    <view class="tab-item {{activeTab === 'drill' ? 'active' : ''}}" bindtap="switchTab" data-tab="drill">
      <text>å†›äº‹æ¼”ä¹ </text>
    </view>
  </view>

  <view class="main-content">
    <!-- å·¦ä¾§å°†é¢†åˆ—è¡¨ -->
    <view class="left-panel">
      <view class="panel-title">æˆ‘çš„å°†é¢† ({{generals.length}})</view>
      <scroll-view scroll-y class="general-scroll">
        <view class="general-item {{selectedGeneral && selectedGeneral.id === item.id ? 'active' : ''}}"
              wx:for="{{generals}}" wx:key="id"
              bindtap="selectGeneral" data-general="{{item}}">
          <view class="general-avatar quality-border-{{item.quality.id || 3}}">
            <image src="{{item.avatar || '/images/avatar-default.png'}}" mode="aspectFill"></image>
          </view>
          <view class="general-info">
            <view class="general-name-row">
              <text class="general-name quality-{{item.quality.id || 3}}">{{item.name}}</text>
              <text class="troop-type">({{item.troopType.name || 'æ­¥'}})</text>
            </view>
            <view class="general-level">Lv.{{item.level || 1}}</view>
          </view>
          <view class="general-power">{{item.attributes.power || 0}}</view>
        </view>
      </scroll-view>
    </view>

    <!-- å³ä¾§è¯¦æƒ…åŒº -->
    <view class="right-panel">
      <!-- å°†é¢†åˆ—è¡¨/è£…å¤‡ -->
      <view class="detail-content" wx:if="{{(activeTab === 'list' || activeTab === 'detail') && selectedGeneral}}">
        <!-- å°†é¢†åŸºæœ¬ä¿¡æ¯ -->
        <view class="general-header">
          <view class="portrait-section">
            <view class="portrait quality-border-{{selectedGeneral.quality.id || 3}}">
              <image src="{{selectedGeneral.avatar || '/images/avatar-default.png'}}" mode="aspectFill"></image>
            </view>
            <view class="level-badge">Lv.{{selectedGeneral.level || 1}}</view>
          </view>
          
          <view class="info-section">
            <view class="name-row">
              <text class="name quality-{{selectedGeneral.quality.id || 3}}">{{selectedGeneral.name}}</text>
              <text class="quality-tag quality-bg-{{selectedGeneral.quality.id || 3}}">{{selectedGeneral.quality.name || 'ä¼˜ç§€'}}</text>
            </view>
            <view class="type-row">
              <text class="type-label">å…µç§ï¼š</text>
              <text class="type-value">{{selectedGeneral.troopType.name || 'æ­¥å…µ'}}</text>
              <text class="faction">ã€{{selectedGeneral.faction || 'ç¾¤é›„'}}ã€‘</text>
            </view>
            <view class="exp-row">
              <text class="exp-label">ç»éªŒï¼š</text>
              <view class="exp-bar">
                <view class="exp-fill" style="width: {{(selectedGeneral.exp / selectedGeneral.maxExp) * 100}}%"></view>
              </view>
              <text class="exp-text">{{selectedGeneral.exp || 0}}/{{selectedGeneral.maxExp || 100}}</text>
            </view>
          </view>
          
          <view class="dismiss-btn" bindtap="showDismissConfirm">è§£é›‡</view>
        </view>

        <!-- å…µç§è¯´æ˜ -->
        <view class="troop-info">
          <view class="troop-icon">{{selectedGeneral.troopType.icon || 'âš”ï¸'}}</view>
          <view class="troop-desc">
            <text wx:if="{{selectedGeneral.troopType.id === 1}}">æ­¥å…µå°†é¢†ï¼šç»Ÿé¢†æ­¥å…µå…µç§ï¼Œæ“…é•¿é˜²å¾¡ï¼Œå±ä¸‹æ­¥å…µçš®ç³™è¡€åšã€‚</text>
            <text wx:elif="{{selectedGeneral.troopType.id === 2}}">éª‘å…µå°†é¢†ï¼šç»Ÿé¢†éª‘å…µå…µç§ï¼Œæ“…é•¿æ•æ‰æˆ˜æœºï¼ŒæœºåŠ¨é«˜ï¼Œæ”»å‡»åŠ›å¼ºã€‚</text>
            <text wx:elif="{{selectedGeneral.troopType.id === 3}}">å¼“å…µå°†é¢†ï¼šç»Ÿé¢†å¼“å…µå…µç§ï¼Œæ‹¥æœ‰æœ€å¼ºå¤§çš„æ€ä¼¤åŠ›ï¼Œæ˜¯å¯é çš„ä¼¤å®³è¾“å‡ºè€…ã€‚</text>
            <text wx:else>{{selectedGeneral.troopType.description || 'ç»Ÿé¢†ç²¾é”éƒ¨é˜Ÿ'}}</text>
          </view>
        </view>

        <!-- å±æ€§é¢æ¿ -->
        <view class="attributes-panel">
          <view class="panel-title">å°†é¢†å±æ€§</view>
          <view class="attr-grid">
            <view class="attr-item">
              <view class="attr-icon">âš”ï¸</view>
              <view class="attr-detail">
                <text class="attr-name">æ­¦å‹‡</text>
                <text class="attr-value">{{selectedGeneral.attributes.valor || 0}}</text>
              </view>
              <text class="attr-desc">å¢åŠ æ”»å‡»ä¼¤å®³</text>
            </view>
            <view class="attr-item">
              <view class="attr-icon">ğŸ›¡ï¸</view>
              <view class="attr-detail">
                <text class="attr-name">ç»Ÿå¾¡</text>
                <text class="attr-value">{{selectedGeneral.attributes.command || 0}}</text>
              </view>
              <text class="attr-desc">æå‡ä¼¤å®³å‡å…</text>
            </view>
            <view class="attr-item">
              <view class="attr-icon">ğŸ’¥</view>
              <view class="attr-detail">
                <text class="attr-name">æ”»å‡»</text>
                <text class="attr-value">{{selectedGeneral.attributes.attack || 0}}</text>
              </view>
              <text class="attr-desc">ç›´æ¥æå‡æ”»å‡»åŠ›</text>
            </view>
            <view class="attr-item">
              <view class="attr-icon">ğŸ°</view>
              <view class="attr-detail">
                <text class="attr-name">é˜²å¾¡</text>
                <text class="attr-value">{{selectedGeneral.attributes.defense || 0}}</text>
              </view>
              <text class="attr-desc">ç›´æ¥æå‡é˜²å¾¡åŠ›</text>
            </view>
            <view class="attr-item">
              <view class="attr-icon">ğŸ’¨</view>
              <view class="attr-detail">
                <text class="attr-name">æœºåŠ¨</text>
                <text class="attr-value">{{selectedGeneral.attributes.mobility || 0}}</text>
              </view>
              <text class="attr-desc">å†³å®šè¡ŒåŠ¨é¡ºåº</text>
            </view>
            <view class="attr-item">
              <view class="attr-icon">âœ¨</view>
              <view class="attr-detail">
                <text class="attr-name">æˆ˜åŠ›</text>
                <text class="attr-value highlight">{{selectedGeneral.attributes.power || 0}}</text>
              </view>
              <text class="attr-desc">ç»¼åˆæˆ˜æ–—åŠ›</text>
            </view>
          </view>
        </view>

        <!-- è£…å¤‡æ§½ä½ï¼ˆdetailæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
        <view class="equipment-panel" wx:if="{{activeTab === 'detail'}}">
          <view class="panel-title">å°†é¢†è£…å¤‡</view>
          <view class="equip-grid">
            <view class="equip-slot" wx:for="{{equipSlots}}" wx:key="id" 
                  bindtap="onEquipSlotTap" data-slot="{{item}}">
              <view class="slot-icon">
                <image wx:if="{{generalEquipments[item.id]}}" 
                       src="{{generalEquipments[item.id].icon || '/images/equip-default.png'}}" 
                       mode="aspectFill"></image>
                <text wx:else class="empty-slot">{{item.icon}}</text>
              </view>
              <view class="slot-name">{{generalEquipments[item.id] ? generalEquipments[item.id].name : item.name}}</view>
              <view class="slot-enhance" wx:if="{{generalEquipments[item.id]}}">
                +{{generalEquipments[item.id].enhanceLevel || 0}}
              </view>
            </view>
          </view>
        </view>

        <!-- ç‰¹æ€§åˆ—è¡¨ -->
        <view class="traits-panel" wx:if="{{selectedGeneral.traits && selectedGeneral.traits.length > 0}}">
          <view class="panel-title">åå°†ç‰¹æ€§</view>
          <view class="traits-list">
            <view class="trait-item" wx:for="{{selectedGeneral.traits}}" wx:key="*this">
              <text class="trait-text">{{item}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å°†é¢†ä¼ æ‰¿ -->
      <view class="inherit-content" wx:if="{{activeTab === 'inherit'}}">
        <view class="inherit-title">å°†é¢†ä¼ æ‰¿</view>
        <view class="inherit-desc">
          é€‰æ‹©ä¼ æ‰¿ç¬¦ï¼Œå°†ä¸€ä¸ªå°†é¢†çš„ç»éªŒä¼ æ‰¿ç»™å¦ä¸€ä¸ªå°†é¢†ã€‚è¢«ä¼ æ‰¿çš„å°†é¢†å°†æ°¸è¿œæ¶ˆå¤±ã€‚
        </view>
        
        <view class="inherit-section">
          <view class="inherit-label">é€‰æ‹©ä¼ æ‰¿ç¬¦</view>
          <view class="scroll-list">
            <view class="scroll-item {{selectedScroll === item.id ? 'selected' : ''}}"
                  wx:for="{{inheritScrolls}}" wx:key="id"
                  bindtap="selectInheritScroll" data-id="{{item.id}}">
              <view class="scroll-icon">ğŸ“œ</view>
              <view class="scroll-info">
                <text class="scroll-name">{{item.name}}</text>
                <text class="scroll-rate">ä¼ æ‰¿ç‡: {{item.rate}}%</text>
              </view>
              <text class="scroll-count">x{{item.count}}</text>
            </view>
          </view>
        </view>

        <view class="inherit-section">
          <view class="inherit-label">é€‰æ‹©è¢«ä¼ æ‰¿å°†é¢†ï¼ˆå°†æ¶ˆå¤±ï¼‰</view>
          <view class="inherit-general-select">
            <view class="general-slot source {{sourceGeneral ? 'has-general' : ''}}"
                  bindtap="selectSourceGeneral">
              <image wx:if="{{sourceGeneral}}" src="{{sourceGeneral.avatar}}" mode="aspectFill"></image>
              <text wx:else>ç‚¹å‡»é€‰æ‹©</text>
              <view class="general-slot-name" wx:if="{{sourceGeneral}}">{{sourceGeneral.name}}</view>
              <view class="exp-info" wx:if="{{sourceGeneral}}">ç»éªŒ: {{sourceGeneral.exp}}</view>
            </view>
            <view class="inherit-arrow">â†’</view>
            <view class="general-slot target {{selectedGeneral ? 'has-general' : ''}}">
              <image wx:if="{{selectedGeneral}}" src="{{selectedGeneral.avatar}}" mode="aspectFill"></image>
              <text wx:else>å·¦ä¾§é€‰æ‹©</text>
              <view class="general-slot-name" wx:if="{{selectedGeneral}}">{{selectedGeneral.name}}</view>
              <view class="exp-info" wx:if="{{selectedGeneral}}">ç»éªŒ: {{selectedGeneral.exp}}</view>
            </view>
          </view>
        </view>

        <view class="inherit-preview" wx:if="{{sourceGeneral && selectedGeneral && selectedScroll}}">
          <text>é¢„è®¡ä¼ æ‰¿ç»éªŒ: {{inheritExpPreview}}</text>
        </view>

        <view class="action-btn {{!canInherit ? 'disabled' : ''}}" bindtap="doInherit">
          å¼€å§‹ä¼ æ‰¿
        </view>
      </view>

      <!-- å†›äº‹æ¼”ä¹  -->
      <view class="drill-content" wx:if="{{activeTab === 'drill'}}">
        <view class="drill-title">å†›äº‹æ¼”ä¹ </view>
        <view class="drill-desc">
          ä½¿ç”¨æ¼”ä¹ ä»¤ï¼Œè®©å°†é¢†é€šè¿‡å†›äº‹æ¼”ä¹ å¿«é€Ÿè·å¾—ç»éªŒï¼Œæå‡ç­‰çº§ã€‚
        </view>

        <view class="drill-general" wx:if="{{selectedGeneral}}">
          <view class="drill-portrait">
            <image src="{{selectedGeneral.avatar}}" mode="aspectFill"></image>
          </view>
          <view class="drill-info">
            <text class="drill-name">{{selectedGeneral.name}}</text>
            <text class="drill-level">Lv.{{selectedGeneral.level}}</text>
            <view class="drill-exp">
              <view class="exp-bar">
                <view class="exp-fill" style="width: {{(selectedGeneral.exp / selectedGeneral.maxExp) * 100}}%"></view>
              </view>
              <text>{{selectedGeneral.exp}}/{{selectedGeneral.maxExp}}</text>
            </view>
          </view>
        </view>

        <view class="drill-items">
          <view class="drill-item {{selectedDrill === item.id ? 'selected' : ''}}"
                wx:for="{{drillItems}}" wx:key="id"
                bindtap="selectDrillItem" data-id="{{item.id}}">
            <view class="drill-icon">{{item.icon}}</view>
            <view class="drill-item-info">
              <text class="drill-item-name">{{item.name}}</text>
              <text class="drill-item-exp">ç»éªŒ +{{item.exp}}</text>
            </view>
            <text class="drill-item-count">x{{item.count}}</text>
          </view>
        </view>

        <view class="drill-count-section">
          <text>ä½¿ç”¨æ•°é‡ï¼š</text>
          <view class="count-control">
            <view class="count-btn" bindtap="decreaseDrillCount">-</view>
            <text class="count-value">{{drillCount}}</text>
            <view class="count-btn" bindtap="increaseDrillCount">+</view>
          </view>
          <view class="max-btn" bindtap="maxDrillCount">æœ€å¤§</view>
        </view>

        <view class="drill-preview" wx:if="{{selectedDrill && drillCount > 0}}">
          <text>é¢„è®¡è·å¾—ç»éªŒ: {{drillExpPreview}}</text>
        </view>

        <view class="action-btn {{!canDrill ? 'disabled' : ''}}" bindtap="doDrill">
          å¼€å§‹æ¼”ä¹ 
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{!selectedGeneral}}">
        <text>è¯·é€‰æ‹©ä¸€ä½å°†é¢†</text>
      </view>
    </view>
  </view>

  <!-- è§£é›‡ç¡®è®¤å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showDismissModal}}" bindtap="closeDismissModal">
    <view class="modal-content" catchtap="">
      <view class="modal-title">è§£é›‡å°†é¢†</view>
      <view class="modal-body">
        <text>ç¡®å®šè¦è§£é›‡ã€{{selectedGeneral.name}}ã€‘å—ï¼Ÿ</text>
        <text class="warning">è§£é›‡åå°†é¢†å°†æ°¸ä¹…æ¶ˆå¤±ï¼Œæ— æ³•æ¢å¤ï¼</text>
      </view>
      <view class="modal-footer">
        <view class="modal-btn cancel" bindtap="closeDismissModal">å–æ¶ˆ</view>
        <view class="modal-btn confirm" bindtap="doDismiss">ç¡®è®¤è§£é›‡</view>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©æºå°†é¢†å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showSourceModal}}" bindtap="closeSourceModal">
    <view class="modal-content large" catchtap="">
      <view class="modal-title">é€‰æ‹©è¢«ä¼ æ‰¿å°†é¢†</view>
      <scroll-view scroll-y class="modal-list">
        <view class="modal-general-item" 
              wx:for="{{generals}}" wx:key="id"
              wx:if="{{!selectedGeneral || item.id !== selectedGeneral.id}}"
              bindtap="confirmSourceGeneral" data-general="{{item}}">
          <image src="{{item.avatar}}" mode="aspectFill"></image>
          <view class="modal-general-info">
            <text class="modal-general-name">{{item.name}}</text>
            <text class="modal-general-level">Lv.{{item.level}} | ç»éªŒ: {{item.exp}}</text>
          </view>
        </view>
      </scroll-view>
      <view class="modal-footer">
        <view class="modal-btn cancel" bindtap="closeSourceModal">å–æ¶ˆ</view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ  -->
  <view class="bottom-bar">
    <view class="back-btn" bindtap="goBack">è¿”å›</view>
  </view>
</view>
