<!--pages/dungeon/dungeon.wxml-->
<view class="page-container">
  <!-- é¡¶éƒ¨æ  -->
  <view class="top-bar">
    <view class="back-btn" bindtap="goBack">
      <text>â—€ è¿”å›</text>
    </view>
    <view class="page-title">{{inBattle ? selectedDungeon.name : 'é€‰æ‹©æˆ˜å½¹'}}</view>
    <view class="player-info">
      <text class="info-item">âš¡ {{stamina}}/100</text>
      <text class="info-item">Lv.{{playerLevel}}</text>
    </view>
  </view>

  <!-- æˆ˜å½¹é€‰æ‹©ç•Œé¢ -->
  <view class="dungeon-select" wx:if="{{!inBattle && !inCombat}}">
    <scroll-view class="dungeon-list" scroll-x>
      <view class="dungeon-card {{selectedDungeon && selectedDungeon.id === item.id ? 'selected' : ''}} {{playerLevel < item.unlockLevel ? 'locked' : ''}}"
            wx:for="{{dungeons}}" wx:key="id"
            data-id="{{item.id}}"
            bindtap="selectDungeon">
        <view class="dungeon-icon">{{item.icon}}</view>
        <view class="dungeon-name">{{item.name}}</view>
        <view class="dungeon-level">Lv.{{item.unlockLevel}}</view>
        <view class="lock-icon" wx:if="{{playerLevel < item.unlockLevel}}">ğŸ”’</view>
      </view>
    </scroll-view>

    <view class="dungeon-detail" wx:if="{{selectedDungeon}}">
      <!-- å‰¯æœ¬ä¿¡æ¯åŒº - å¯æ»šåŠ¨ -->
      <scroll-view class="detail-content" scroll-y>
        <view class="detail-header">
          <text class="detail-name">{{selectedDungeon.icon}} {{selectedDungeon.name}}</text>
          <text class="detail-desc">{{selectedDungeon.description}}</text>
        </view>
        
        <view class="detail-info">
          <view class="info-row">
            <text>å®ˆå…³æ­¦å°†ï¼š{{selectedDungeon.npcCount}}äºº</text>
            <text>æ¶ˆè€—ä½“åŠ›ï¼š{{selectedDungeon.staminaCost}}</text>
          </view>
          <view class="info-row">
            <text>è§£é”ç­‰çº§ï¼šLv.{{selectedDungeon.unlockLevel}}</text>
            <text wx:if="{{playerLevel >= selectedDungeon.unlockLevel}}">ä»Šæ—¥å‰©ä½™ï¼š{{5 - (progress.todayEntries || 0)}}/5æ¬¡</text>
            <text wx:else class="locked-text">ğŸ”’ æœªè§£é”</text>
          </view>
          <view class="info-row">
            <text>æ¨èæˆ˜åŠ›ï¼š{{selectedDungeon.recommendedPower}}</text>
            <text>æˆ‘æ–¹æˆ˜åŠ›ï¼š{{totalPower}}</text>
          </view>
        </view>
        
        <!-- é˜µå‹é¢„è§ˆ -->
        <view class="formation-row">
          <text class="formation-label">å½“å‰é˜µå‹ ({{formationCount}}/6):</text>
          <view class="formation-mini">
            <view class="mini-slot {{item.name ? 'filled' : ''}}" wx:for="{{formation}}" wx:key="index">
              <text wx:if="{{item.name}}">{{item.name}}</text>
            </view>
            <view class="mini-slot empty" wx:for="{{6 - formation.length}}" wx:key="*this">
              <text>ç©º</text>
            </view>
          </view>
        </view>
        
        <view class="formation-warning" wx:if="{{formationCount === 0}}">
          âš ï¸ è¯·å…ˆé…ç½®é˜µå‹æ‰èƒ½è¿›å…¥æˆ˜å½¹
        </view>
        
        <view class="detail-lore" wx:if="{{selectedDungeon.lore}}">{{selectedDungeon.lore}}</view>
      </scroll-view>
      
      <!-- åº•éƒ¨æ“ä½œæŒ‰é’® - å§‹ç»ˆå›ºå®šæ˜¾ç¤º -->
      <view class="action-bar">
        <view class="action-btn config-btn" bindtap="goToFormation">âš”ï¸ é…ç½®é˜µå‹</view>
        <view class="action-btn enter-btn {{formationCount === 0 || playerLevel < selectedDungeon.unlockLevel || stamina < selectedDungeon.staminaCost ? 'disabled' : ''}}" 
              bindtap="enterDungeon">
          <block wx:if="{{playerLevel < selectedDungeon.unlockLevel}}">ğŸ”’ éœ€è¦Lv.{{selectedDungeon.unlockLevel}}</block>
          <block wx:elif="{{formationCount === 0}}">âš ï¸ è¯·å…ˆé…ç½®é˜µå‹</block>
          <block wx:elif="{{stamina < selectedDungeon.staminaCost}}">âš¡ ä½“åŠ›ä¸è¶³</block>
          <block wx:else>ğŸš€ è¿›å…¥æˆ˜å½¹</block>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆ˜æ–—å‡†å¤‡ç•Œé¢ -->
  <view class="battle-prep" wx:if="{{inBattle && !inCombat}}">
    <view class="prep-header">
      <text class="prep-progress">ç¬¬ {{currentNpcIndex + 1}} / {{selectedDungeon.npcCount}} å…³</text>
    </view>
    
    <scroll-view class="prep-content" scroll-y>
      <view class="prep-inner">
        <view class="npc-preview">
          <view class="npc-icon-large">{{currentNpc.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¤'}}</view>
          <view class="npc-details">
            <text class="npc-name" style="color: {{currentNpc.qualityColor}}">{{currentNpc.name}}</text>
            <text class="npc-quality">{{currentNpc.qualityName}}å“è´¨</text>
            <text class="npc-power">æˆ˜åŠ› {{currentNpc.power}}</text>
          </view>
        </view>
        
        <view class="drop-info">
          <text class="drop-title">é€šå…³å¥–åŠ±</text>
          <view class="drop-list">
            <text>ğŸ“ˆ ç»éªŒ +{{currentNpc.expReward || 100}}</text>
            <text wx:if="{{currentNpc.dropEquipment}}">ğŸ {{currentNpc.dropRate}}%æ‰è½è£…å¤‡</text>
          </view>
        </view>
        
        <view class="my-team-preview">
          <text class="team-title">æˆ‘æ–¹é˜µå®¹ (æˆ˜åŠ›: {{totalPower}})</text>
          <view class="team-list">
            <view class="team-member" wx:for="{{formation}}" wx:key="index">
              <view class="member-icon">{{item.troopIcon || 'ğŸ›¡ï¸'}}</view>
              <text class="member-name">{{item.name}}</text>
              <text class="member-mob">æœº{{item.mobility}}</text>
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
    
    <button class="start-battle-btn" bindtap="startCombat">âš”ï¸ å¼€å§‹æˆ˜æ–—</button>
  </view>

  <!-- å›åˆåˆ¶æˆ˜æ–—ç•Œé¢ - å·¦å³å¯¹æˆ˜å¸ƒå±€ -->
  <view class="combat-arena" wx:if="{{inCombat}}">
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <view class="combat-top-bar">
      <!-- æˆ‘æ–¹ä¿¡æ¯ -->
      <view class="commander-info my-commander">
        <image class="commander-avatar" src="/images/logo.png" mode="aspectFill"></image>
        <view class="commander-detail">
          <text class="commander-name">ä¸»å…¬ Lv.{{playerLevel}}</text>
          <view class="commander-hp-bar">
            <view class="commander-hp-fill my-hp" style="width: {{myTotalHp / myMaxHp * 100}}%"></view>
          </view>
        </view>
      </view>
      
      <!-- å›åˆæŒ‡ç¤º -->
      <view class="round-badge">
        <text class="round-label">æˆ˜</text>
        <text class="round-number">ç¬¬{{currentRound}}å›åˆ</text>
      </view>
      
      <!-- æ•Œæ–¹ä¿¡æ¯ -->
      <view class="commander-info enemy-commander">
        <view class="commander-detail">
          <text class="commander-name" style="color: {{currentNpc.qualityColor}}">{{currentNpc.name}} Lv.{{currentNpc.level}}</text>
          <view class="commander-hp-bar">
            <view class="commander-hp-fill enemy-hp" style="width: {{enemyTotalHp / enemyMaxHp * 100}}%"></view>
          </view>
        </view>
        <view class="commander-avatar enemy-avatar-img">{{currentNpc.isBoss ? 'ğŸ‘¹' : 'ğŸ‘¤'}}</view>
      </view>
    </view>

    <!-- æˆ˜åœºä¸»åŒºåŸŸ - å·¦å³å¯¹æˆ˜ -->
    <view class="battlefield-area">
      <!-- æˆ‘æ–¹é˜µå‹ (å·¦ä¾§) - 3è¡Œ2åˆ— -->
      <view class="army-side my-army-side">
        <view class="army-grid">
          <!-- åæ’ -->
          <view class="army-row back-row">
            <view class="troop-unit {{myUnits[4] && myUnits[4].isDead ? 'dead' : ''}} {{myUnits[4] && myUnits[4].isAttacking ? 'attacking' : ''}} {{myUnits[4] && myUnits[4].isHit ? 'hit' : ''}}" wx:if="{{myUnits[4]}}">
              <view class="troop-flag my-flag">ğŸš©</view>
              <view class="troop-avatar">{{myUnits[4].troopIcon || 'ğŸ›¡ï¸'}}</view>
              <view class="troop-soldiers">{{myUnits[4].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill" style="width: {{myUnits[4].currentHp / myUnits[4].maxHp * 100}}%"></view></view>
              <text class="troop-name">{{myUnits[4].name}}</text>
            </view>
            <view class="troop-unit {{myUnits[5] && myUnits[5].isDead ? 'dead' : ''}} {{myUnits[5] && myUnits[5].isAttacking ? 'attacking' : ''}} {{myUnits[5] && myUnits[5].isHit ? 'hit' : ''}}" wx:if="{{myUnits[5]}}">
              <view class="troop-flag my-flag">ğŸš©</view>
              <view class="troop-avatar">{{myUnits[5].troopIcon || 'ğŸ›¡ï¸'}}</view>
              <view class="troop-soldiers">{{myUnits[5].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill" style="width: {{myUnits[5].currentHp / myUnits[5].maxHp * 100}}%"></view></view>
              <text class="troop-name">{{myUnits[5].name}}</text>
            </view>
          </view>
          <!-- ä¸­æ’ -->
          <view class="army-row mid-row">
            <view class="troop-unit {{myUnits[2] && myUnits[2].isDead ? 'dead' : ''}} {{myUnits[2] && myUnits[2].isAttacking ? 'attacking' : ''}} {{myUnits[2] && myUnits[2].isHit ? 'hit' : ''}}" wx:if="{{myUnits[2]}}">
              <view class="troop-flag my-flag">ğŸš©</view>
              <view class="troop-avatar">{{myUnits[2].troopIcon || 'ğŸ›¡ï¸'}}</view>
              <view class="troop-soldiers">{{myUnits[2].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill" style="width: {{myUnits[2].currentHp / myUnits[2].maxHp * 100}}%"></view></view>
              <text class="troop-name">{{myUnits[2].name}}</text>
            </view>
            <view class="troop-unit {{myUnits[3] && myUnits[3].isDead ? 'dead' : ''}} {{myUnits[3] && myUnits[3].isAttacking ? 'attacking' : ''}} {{myUnits[3] && myUnits[3].isHit ? 'hit' : ''}}" wx:if="{{myUnits[3]}}">
              <view class="troop-flag my-flag">ğŸš©</view>
              <view class="troop-avatar">{{myUnits[3].troopIcon || 'ğŸ›¡ï¸'}}</view>
              <view class="troop-soldiers">{{myUnits[3].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill" style="width: {{myUnits[3].currentHp / myUnits[3].maxHp * 100}}%"></view></view>
              <text class="troop-name">{{myUnits[3].name}}</text>
            </view>
          </view>
          <!-- å‰æ’ -->
          <view class="army-row front-row">
            <view class="troop-unit {{myUnits[0] && myUnits[0].isDead ? 'dead' : ''}} {{myUnits[0] && myUnits[0].isAttacking ? 'attacking' : ''}} {{myUnits[0] && myUnits[0].isHit ? 'hit' : ''}}" wx:if="{{myUnits[0]}}">
              <view class="troop-flag my-flag">ğŸš©</view>
              <view class="troop-avatar">{{myUnits[0].troopIcon || 'ğŸ›¡ï¸'}}</view>
              <view class="troop-soldiers">{{myUnits[0].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill" style="width: {{myUnits[0].currentHp / myUnits[0].maxHp * 100}}%"></view></view>
              <text class="troop-name">{{myUnits[0].name}}</text>
            </view>
            <view class="troop-unit {{myUnits[1] && myUnits[1].isDead ? 'dead' : ''}} {{myUnits[1] && myUnits[1].isAttacking ? 'attacking' : ''}} {{myUnits[1] && myUnits[1].isHit ? 'hit' : ''}}" wx:if="{{myUnits[1]}}">
              <view class="troop-flag my-flag">ğŸš©</view>
              <view class="troop-avatar">{{myUnits[1].troopIcon || 'ğŸ›¡ï¸'}}</view>
              <view class="troop-soldiers">{{myUnits[1].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill" style="width: {{myUnits[1].currentHp / myUnits[1].maxHp * 100}}%"></view></view>
              <text class="troop-name">{{myUnits[1].name}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- ä¸­é—´æˆ˜æ–—æ•ˆæœ -->
      <view class="battle-center">
        <view class="battle-effect {{showEffect ? 'show' : ''}}">{{effectText}}</view>
        <view class="damage-popup {{showDamage ? 'show' : ''}}" style="color: {{damageColor}}">{{damageText}}</view>
      </view>
      
      <!-- æ•Œæ–¹é˜µå‹ (å³ä¾§) - 3è¡Œ2åˆ— -->
      <view class="army-side enemy-army-side">
        <view class="army-grid enemy-grid">
          <!-- å‰æ’ï¼ˆå¯¹äºæ•Œæ–¹æ¥è¯´é è¿‘ä¸­é—´ï¼‰ -->
          <view class="army-row front-row">
            <view class="troop-unit enemy-troop {{enemyUnits[0] && enemyUnits[0].isDead ? 'dead' : ''}} {{enemyUnits[0] && enemyUnits[0].isAttacking ? 'attacking' : ''}} {{enemyUnits[0] && enemyUnits[0].isHit ? 'hit' : ''}}" wx:if="{{enemyUnits[0]}}">
              <view class="troop-flag enemy-flag">ğŸ´</view>
              <view class="troop-avatar enemy-avatar-icon">{{enemyUnits[0].troopIcon || (enemyUnits[0].isBoss ? 'ğŸ‘¹' : 'ğŸ›¡ï¸')}}</view>
              <view class="troop-soldiers enemy-soldiers">{{enemyUnits[0].currentHp}}</view>
              <view class="troop-hp-bar"><view class="troop-hp-fill enemy-hp-fill" style="width: {{enemyUnits[0].currentHp / enemyUnits[0].maxHp * 100}}%"></view></view>
              <text class="troop-name" style="color: {{enemyUnits[0].qualityColor}}">{{enemyUnits[0].name}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆ˜æ–—æ—¥å¿— -->
    <view class="combat-log-panel">
      <scroll-view class="log-scroll-view" scroll-y scroll-into-view="log-{{combatLogs.length - 1}}">
        <view class="log-entry {{item.type}}" wx:for="{{combatLogs}}" wx:key="index" id="log-{{index}}">
          {{item.text}}
        </view>
      </scroll-view>
    </view>

    <!-- ç»“æœæŒ‰é’® -->
    <view class="result-button-area" wx:if="{{combatEnded}}">
      <button class="result-btn {{combatVictory ? 'victory' : 'defeat'}}" bindtap="handleCombatEnd">
        {{combatVictory ? 'ğŸ‰ èƒœåˆ© - ç»§ç»­' : 'ğŸ’” å¤±è´¥ - è¿”å›'}}
      </button>
    </view>
  </view>

  <!-- æˆ˜å½¹é€šå…³å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showClearModal}}" catchtap="">
    <view class="clear-modal">
      <view class="clear-header">
        <text class="clear-title">ğŸ† æˆ˜å½¹é€šå…³!</text>
        <text class="clear-dungeon">{{selectedDungeon.name}}</text>
      </view>
      <view class="clear-rewards">
        <view class="reward-item">
          <text class="reward-icon">ğŸ“ˆ</text>
          <text>ç»éªŒ +{{selectedDungeon.clearReward.exp}}</text>
        </view>
        <view class="reward-item">
          <text class="reward-icon">ğŸ’°</text>
          <text>é“¶ä¸¤ +{{selectedDungeon.clearReward.silver}}</text>
        </view>
      </view>
      <button class="clear-btn" bindtap="exitBattle">è¿”å›</button>
    </view>
  </view>
</view>
