<!-- pages/alliance/alliance.wxml -->
<view class="alliance-page">
  <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
  <view class="header">
    <view class="header-title">è”ç›Ÿ</view>
    <view class="header-close" bindtap="goBack">è¿”å›</view>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <view class="main-content">
    <!-- è¡¨å¤´ -->
    <view class="table-header">
      <view class="col col-name">è”ç›Ÿåç§°</view>
      <view class="col col-leader">ç›Ÿä¸»</view>
      <view class="col col-faction">å›½å®¶</view>
      <view class="col col-members">æˆå‘˜</view>
      <view class="col col-action">æ“ä½œ</view>
    </view>

    <!-- è”ç›Ÿåˆ—è¡¨ -->
    <scroll-view class="alliance-list" scroll-y>
      <view 
        class="alliance-row" 
        wx:for="{{allianceList}}" 
        wx:key="id"
        bindtap="viewAllianceDetail"
        data-alliance="{{item}}"
      >
        <view class="col col-name">
          <text class="alliance-name">{{item.name}}</text>
        </view>
        <view class="col col-leader">
          <text class="leader-name {{item.faction === 'èœ€' ? 'shu' : item.faction === 'é­' ? 'wei' : 'wu'}}">{{item.leaderName}}</text>
        </view>
        <view class="col col-faction">
          <text class="faction-tag {{item.faction === 'èœ€' ? 'shu' : item.faction === 'é­' ? 'wei' : 'wu'}}">{{item.faction}}</text>
        </view>
        <view class="col col-members">{{item.memberCount}}</view>
        <view class="col col-action">
          <view 
            class="btn-apply" 
            catchtap="applyJoin" 
            data-alliance="{{item}}"
            wx:if="{{!hasAlliance}}"
          >ç”³è¯·åŠ å…¥</view>
          <view class="btn-view" wx:else>æŸ¥çœ‹</view>
        </view>
      </view>
      
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{allianceList.length === 0 && !loading}}">
        <text>æš‚æ— è”ç›Ÿæ•°æ®</text>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="bottom-bar">
      <view class="btn-create" bindtap="showCreateAlliance" wx:if="{{!hasAlliance}}">åˆ›å»ºè”ç›Ÿ</view>
      <view class="btn-my-alliance" bindtap="viewAllianceDetail" data-alliance="{{myAlliance}}" wx:else>æˆ‘çš„è”ç›Ÿ</view>
    </view>
  </view>

  <!-- åˆ›å»ºè”ç›Ÿå¼¹çª— -->
  <view class="modal-mask" wx:if="{{showCreateModal}}" bindtap="closeCreateModal">
    <view class="modal-content create-modal" catchtap>
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºè”ç›Ÿ</text>
        <view class="modal-close" bindtap="closeCreateModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="form-item">
          <text class="form-label">è”ç›Ÿåç§°</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥è”ç›Ÿåç§°(2-8å­—)" 
            value="{{newAllianceName}}"
            bindinput="onAllianceNameInput"
            maxlength="8"
          />
        </view>
        
        <view class="form-item">
          <text class="form-label">é€‰æ‹©å›½å®¶</text>
          <view class="faction-select">
            <view 
              class="faction-option shu {{selectedFaction === 'èœ€' ? 'selected' : ''}} {{playerInfo.faction !== 'èœ€' ? 'disabled' : ''}}"
              bindtap="onFactionSelect"
              data-faction="èœ€"
            >èœ€</view>
            <view 
              class="faction-option wei {{selectedFaction === 'é­' ? 'selected' : ''}} {{playerInfo.faction !== 'é­' ? 'disabled' : ''}}"
              bindtap="onFactionSelect"
              data-faction="é­"
            >é­</view>
            <view 
              class="faction-option wu {{selectedFaction === 'å´' ? 'selected' : ''}} {{playerInfo.faction !== 'å´' ? 'disabled' : ''}}"
              bindtap="onFactionSelect"
              data-faction="å´"
            >å´</view>
          </view>
        </view>
        
        <view class="create-tip">
          <text>* åˆ›å»ºè”ç›Ÿéœ€è¦æ¶ˆè€— 1000 é»„é‡‘</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeCreateModal">å–æ¶ˆ</view>
        <view class="btn-confirm" bindtap="createAlliance">ç¡®å®šåˆ›å»º</view>
      </view>
    </view>
  </view>

  <!-- è”ç›Ÿè¯¦æƒ…å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showDetailModal}}" bindtap="closeDetailModal">
    <view class="modal-content detail-modal" catchtap>
      <!-- æ ‡ç­¾æ  -->
      <view class="tab-bar">
        <view class="tab-item {{currentTab === 'info' ? 'active' : ''}}" bindtap="switchTab" data-tab="info">è”ç›Ÿä¿¡æ¯</view>
        <view class="tab-item {{currentTab === 'members' ? 'active' : ''}}" bindtap="switchTab" data-tab="members">æˆå‘˜ç®¡ç†</view>
        <view class="tab-item {{currentTab === 'rewards' ? 'active' : ''}}" bindtap="switchTab" data-tab="rewards">è”ç›Ÿå¥–åŠ±</view>
        <view class="tab-close" bindtap="closeDetailModal">è¿”å›</view>
      </view>

      <!-- è”ç›Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
      <view class="tab-content" wx:if="{{currentTab === 'info'}}">
        <view class="info-section">
          <view class="info-row">
            <text class="info-label">è”ç›Ÿåç§°:</text>
            <text class="info-value">{{detailAlliance.name}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">ç›Ÿ  ä¸»:</text>
            <text class="info-value leader-name">{{detailAlliance.leaderName}}</text>
          </view>
          <view class="info-row">
            <text class="info-label">è”ç›Ÿæˆå‘˜:</text>
            <text class="info-value">{{detailAlliance.memberCount}}/{{detailAlliance.maxMembers}}</text>
          </view>
        </view>
        
        <view class="announcement-section">
          <view class="announcement-header">
            <text>å…¬å‘Š</text>
            <text class="edit-btn" wx:if="{{hasAlliance && myAlliance.id === detailAlliance.id}}">ç¼–è¾‘</text>
          </view>
          <view class="announcement-content">
            <text>{{detailAlliance.announcement || 'æš‚æ— å…¬å‘Š'}}</text>
          </view>
        </view>
        
        <!-- æˆå‘˜åˆ—è¡¨é¢„è§ˆ -->
        <view class="members-preview">
          <view class="preview-header">
            <text class="col-name">æˆå‘˜å</text>
            <text class="col-position">èŒä½</text>
            <text class="col-level">ç­‰çº§</text>
            <text class="col-contribution">ç´¯æˆ˜ç§¯åˆ†</text>
          </view>
          <scroll-view class="preview-list" scroll-y>
            <view class="member-row" wx:for="{{detailAlliance.members}}" wx:key="odUserId">
              <text class="col-name {{item.position === 'ç›Ÿä¸»' ? 'leader' : ''}}">{{item.name}}</text>
              <text class="col-position">{{item.position}}</text>
              <text class="col-level">{{item.level}}</text>
              <text class="col-contribution">{{item.contribution || 0}}</text>
            </view>
          </scroll-view>
        </view>
        
        <!-- ç›Ÿæˆ˜å…¥å£ -->
        <view class="war-entry" wx:if="{{hasAlliance && myAlliance.id === detailAlliance.id}}" bindtap="goToAllianceWar">
          <view class="war-entry-icon">âš”ï¸</view>
          <view class="war-entry-info">
            <text class="war-entry-title">ç›Ÿæˆ˜</text>
            <text class="war-entry-desc">æ¯æ—¥20:45æŠ¥åï¼Œ21:00å¼€æˆ˜</text>
          </view>
          <view class="war-entry-arrow">â€º</view>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="action-buttons" wx:if="{{hasAlliance && myAlliance.id === detailAlliance.id}}">
          <view class="btn-applications" bindtap="viewApplications">ç”³è¯·åˆ—è¡¨</view>
          <view class="btn-manage" bindtap="switchTab" data-tab="members">æˆå‘˜ç®¡ç†</view>
          <view class="btn-dissolve" bindtap="dissolveAlliance" wx:if="{{myAlliance.leaderId === playerInfo.id}}">è§£æ•£è”ç›Ÿ</view>
          <view class="btn-leave" bindtap="leaveAlliance" wx:else>é€€å‡ºè”ç›Ÿ</view>
        </view>
      </view>

      <!-- æˆå‘˜ç®¡ç†æ ‡ç­¾é¡µ -->
      <view class="tab-content" wx:if="{{currentTab === 'members'}}">
        <view class="members-management">
          <view class="members-header">
            <text class="col-name">æˆå‘˜å</text>
            <text class="col-position">èŒä½</text>
            <text class="col-level">ç­‰çº§</text>
            <text class="col-power">æˆ˜åŠ›</text>
            <text class="col-action">æ“ä½œ</text>
          </view>
          <scroll-view class="members-list" scroll-y>
            <view class="member-row" wx:for="{{detailAlliance.members}}" wx:key="odUserId">
              <text class="col-name">{{item.name}}</text>
              <text class="col-position">{{item.position}}</text>
              <text class="col-level">{{item.level}}</text>
              <text class="col-power">{{item.power}}</text>
              <view class="col-action" wx:if="{{item.position !== 'ç›Ÿä¸»' && hasAlliance && myAlliance.leaderId === playerInfo.id}}">
                <text class="action-btn" catchtap="setPosition" data-member="{{item}}">èŒä½</text>
                <text class="action-btn kick" catchtap="kickMember" data-member="{{item}}">è¸¢å‡º</text>
              </view>
              <view class="col-action" wx:else>-</view>
            </view>
          </scroll-view>
        </view>
      </view>

      <!-- è”ç›Ÿå¥–åŠ±æ ‡ç­¾é¡µ -->
      <view class="tab-content" wx:if="{{currentTab === 'rewards'}}">
        <view class="rewards-section">
          <view class="reward-item">
            <view class="reward-icon">ğŸ†</view>
            <view class="reward-info">
              <text class="reward-name">è”ç›Ÿæˆ˜å¥–åŠ±</text>
              <text class="reward-desc">å‚ä¸è”ç›Ÿæˆ˜å¯è·å¾—ä¸°åšå¥–åŠ±</text>
            </view>
          </view>
          <view class="reward-item">
            <view class="reward-icon">ğŸ’°</view>
            <view class="reward-info">
              <text class="reward-name">æ¯æ—¥ç­¾åˆ°</text>
              <text class="reward-desc">æ¯æ—¥ç­¾åˆ°å¯è·å¾—è”ç›Ÿè´¡çŒ®</text>
            </view>
          </view>
          <view class="reward-item">
            <view class="reward-icon">â­</view>
            <view class="reward-info">
              <text class="reward-name">è”ç›Ÿå•†åº—</text>
              <text class="reward-desc">ä½¿ç”¨è´¡çŒ®å…‘æ¢ç¨€æœ‰é“å…·</text>
            </view>
          </view>
        </view>
        <view class="coming-soon">
          <text>æ›´å¤šè”ç›Ÿç©æ³•å¼€å‘ä¸­...</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç”³è¯·åˆ—è¡¨å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showApplicationModal}}" bindtap="closeApplicationModal">
    <view class="modal-content application-modal" catchtap>
      <view class="modal-header">
        <text class="modal-title">ç”³è¯·åˆ—è¡¨</text>
        <view class="modal-close" bindtap="closeApplicationModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <scroll-view class="application-list" scroll-y>
          <view class="application-item" wx:for="{{applicationList}}" wx:key="odUserId">
            <view class="applicant-info">
              <text class="applicant-name">{{item.name}}</text>
              <text class="applicant-level">Lv.{{item.level}}</text>
              <text class="applicant-power">æˆ˜åŠ›: {{item.power}}</text>
            </view>
            <view class="applicant-actions">
              <view class="btn-approve" catchtap="approveApplication" data-applicant-id="{{item.odUserId}}">åŒæ„</view>
              <view class="btn-reject" catchtap="rejectApplication" data-applicant-id="{{item.odUserId}}">æ‹’ç»</view>
            </view>
          </view>
          
          <view class="empty-state" wx:if="{{applicationList.length === 0}}">
            <text>æš‚æ— ç”³è¯·</text>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</view>
