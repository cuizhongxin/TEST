<!-- pages/production/production.wxml -->
<view class="production-page">
  <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 'produce' ? 'active' : ''}}" bindtap="switchTab" data-tab="produce">ç”Ÿäº§</view>
    <view class="tab-item {{currentTab === 'manufacture' ? 'active' : ''}}" bindtap="switchTab" data-tab="manufacture">åˆ¶é€ </view>
    <view class="tab-close" bindtap="goBack">è¿”å›</view>
  </view>

  <!-- ç”Ÿäº§æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{currentTab === 'produce'}}">
    <scroll-view class="facility-grid" scroll-y>
      <!-- è®¾æ–½å¡ç‰‡ -->
      <view class="facility-card" wx:for="{{facilities}}" wx:key="id">
        <view class="facility-image">
          <view class="facility-icon">
            <text wx:if="{{item.type === 'silver'}}">ğŸ›ï¸</text>
            <text wx:elif="{{item.type === 'metal'}}">â›ï¸</text>
            <text wx:elif="{{item.type === 'food'}}">ğŸŒ¾</text>
            <text wx:else>ğŸ“œ</text>
          </view>
        </view>
        <view class="facility-info">
          <view class="facility-name">{{item.name}}</view>
          <view class="facility-stats">
            <text>å½“å‰ç­‰çº§: {{item.level}}</text>
            <text>å•æ¬¡äº§é‡: {{item.outputPerTime}}</text>
            <text>æ¯æ—¥æ¬¡æ•°: {{item.usedToday}}/{{item.dailyLimit}}</text>
          </view>
        </view>
        <view class="facility-actions">
          <view class="btn-produce {{item.usedToday >= item.dailyLimit ? 'disabled' : ''}}" 
                bindtap="produce" data-facility="{{item}}">
            {{item.btnText}}
          </view>
          <view class="btn-upgrade" bindtap="upgradeFacility" data-facility="{{item}}">å‡çº§</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åˆ¶é€ æ ‡ç­¾é¡µ -->
  <view class="tab-content" wx:if="{{currentTab === 'manufacture'}}">
    <!-- åˆ¶é€ è®¾æ–½é€‰æ‹© -->
    <view class="manufacture-tabs">
      <view 
        class="manufacture-tab {{selectedManufacture && selectedManufacture.type === item.type ? 'active' : ''}}"
        wx:for="{{manufactureFacilities}}" 
        wx:key="id"
        bindtap="selectManufacture"
        data-facility="{{item}}"
      >
        <text class="tab-icon">{{item.icon}}</text>
        <text class="tab-name">{{item.name}}</text>
        <text class="tab-level">Lv.{{item.level}}</text>
      </view>
    </view>

    <!-- è®¾æ–½ä¿¡æ¯ -->
    <view class="manufacture-info" wx:if="{{selectedManufacture}}">
      <view class="info-header">
        <text class="info-name">{{selectedManufacture.name}}</text>
        <text class="info-level">ç­‰çº§ {{selectedManufacture.level}}/{{selectedManufacture.maxLevel}}</text>
        <view class="btn-upgrade-small" bindtap="upgradeManufacture" data-facility="{{selectedManufacture}}">å‡çº§</view>
      </view>
      <view class="info-desc">{{selectedManufacture.description}}</view>
    </view>

    <!-- é…æ–¹åˆ—è¡¨ -->
    <scroll-view class="recipe-list" scroll-y>
      <view 
        class="recipe-card {{!item.canMake ? 'disabled' : ''}} {{item.quality}}"
        wx:for="{{recipes}}" 
        wx:key="id"
        bindtap="showRecipeDetail"
        data-recipe="{{item}}"
      >
        <view class="recipe-icon">
          <text wx:if="{{item.resultType === 'equipment'}}">ğŸ—¡ï¸</text>
          <text wx:elif="{{item.resultType === 'item'}}">ğŸ“¦</text>
          <text wx:else>ğŸ“–</text>
        </view>
        <view class="recipe-info">
          <view class="recipe-name">{{item.name}}</view>
          <view class="recipe-quality quality-{{item.quality === 'ä¼ è¯´' ? 'legendary' : item.quality === 'å²è¯—' ? 'epic' : item.quality === 'ç²¾è‰¯' ? 'rare' : item.quality === 'ä¼˜ç§€' ? 'good' : 'normal'}}">{{item.quality}}</view>
          <view class="recipe-require" wx:if="{{!item.levelEnough}}">éœ€è¦{{item.requiredLevel}}çº§</view>
        </view>
        <view class="recipe-cost">
          <text wx:if="{{item.costSilver > 0}}">ğŸ’°{{item.costSilver}}</text>
          <text wx:if="{{item.costMetal > 0}}">â›ï¸{{item.costMetal}}</text>
          <text wx:if="{{item.costFood > 0}}">ğŸŒ¾{{item.costFood}}</text>
          <text wx:if="{{item.costPaper > 0}}">ğŸ“œ{{item.costPaper}}</text>
        </view>
        <view class="btn-make {{item.canMake ? '' : 'disabled'}}" catchtap="manufacture" data-recipe="{{item}}">
          åˆ¶é€ 
        </view>
      </view>
      
      <view class="empty-state" wx:if="{{recipes.length === 0}}">
        <text>æš‚æ— å¯åˆ¶é€ é…æ–¹</text>
      </view>
    </scroll-view>
  </view>

  <!-- åº•éƒ¨èµ„æºæ  -->
  <view class="resource-bar">
    <view class="resource-item">
      <text class="resource-icon">ğŸ’°</text>
      <text class="resource-label">ç™½é“¶:</text>
      <text class="resource-value">{{resource.silver}}</text>
    </view>
    <view class="resource-item">
      <text class="resource-icon">â›ï¸</text>
      <text class="resource-label">é‡‘å±:</text>
      <text class="resource-value">{{resource.metal}}</text>
    </view>
    <view class="resource-item">
      <text class="resource-icon">ğŸŒ¾</text>
      <text class="resource-label">ç²®é£Ÿ:</text>
      <text class="resource-value">{{resource.food}}</text>
    </view>
    <view class="resource-item">
      <text class="resource-icon">ğŸ“œ</text>
      <text class="resource-label">çº¸å¼ :</text>
      <text class="resource-value">{{resource.paper}}</text>
    </view>
  </view>

  <!-- é…æ–¹è¯¦æƒ…å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showRecipeModal}}" bindtap="closeRecipeModal">
    <view class="modal-content" catchtap>
      <view class="modal-header">
        <text class="modal-title">{{selectedRecipe.name}}</text>
        <view class="modal-close" bindtap="closeRecipeModal">Ã—</view>
      </view>
      
      <view class="modal-body">
        <view class="recipe-detail">
          <view class="detail-row">
            <text class="detail-label">å“è´¨:</text>
            <text class="detail-value quality-{{selectedRecipe.quality === 'ä¼ è¯´' ? 'legendary' : selectedRecipe.quality === 'å²è¯—' ? 'epic' : selectedRecipe.quality === 'ç²¾è‰¯' ? 'rare' : selectedRecipe.quality === 'ä¼˜ç§€' ? 'good' : 'normal'}}">{{selectedRecipe.quality}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">æè¿°:</text>
            <text class="detail-value">{{selectedRecipe.description}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">éœ€è¦ç­‰çº§:</text>
            <text class="detail-value {{selectedRecipe.levelEnough ? '' : 'insufficient'}}">{{selectedRecipe.requiredLevel}}çº§</text>
          </view>
          
          <view class="cost-section">
            <text class="cost-title">åˆ¶é€ æ¶ˆè€—:</text>
            <view class="cost-list">
              <view class="cost-item" wx:if="{{selectedRecipe.costSilver > 0}}">
                <text class="cost-icon">ğŸ’°</text>
                <text class="cost-name">ç™½é“¶</text>
                <text class="cost-value {{resource.silver >= selectedRecipe.costSilver ? '' : 'insufficient'}}">{{selectedRecipe.costSilver}}</text>
              </view>
              <view class="cost-item" wx:if="{{selectedRecipe.costMetal > 0}}">
                <text class="cost-icon">â›ï¸</text>
                <text class="cost-name">é‡‘å±</text>
                <text class="cost-value {{resource.metal >= selectedRecipe.costMetal ? '' : 'insufficient'}}">{{selectedRecipe.costMetal}}</text>
              </view>
              <view class="cost-item" wx:if="{{selectedRecipe.costFood > 0}}">
                <text class="cost-icon">ğŸŒ¾</text>
                <text class="cost-name">ç²®é£Ÿ</text>
                <text class="cost-value {{resource.food >= selectedRecipe.costFood ? '' : 'insufficient'}}">{{selectedRecipe.costFood}}</text>
              </view>
              <view class="cost-item" wx:if="{{selectedRecipe.costPaper > 0}}">
                <text class="cost-icon">ğŸ“œ</text>
                <text class="cost-name">çº¸å¼ </text>
                <text class="cost-value {{resource.paper >= selectedRecipe.costPaper ? '' : 'insufficient'}}">{{selectedRecipe.costPaper}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeRecipeModal">å–æ¶ˆ</view>
        <view class="btn-confirm {{selectedRecipe.canMake ? '' : 'disabled'}}" bindtap="manufacture">
          {{selectedRecipe.canMake ? 'ç«‹å³åˆ¶é€ ' : (selectedRecipe.levelEnough ? 'èµ„æºä¸è¶³' : 'ç­‰çº§ä¸è¶³')}}
        </view>
      </view>
    </view>
  </view>
</view>
